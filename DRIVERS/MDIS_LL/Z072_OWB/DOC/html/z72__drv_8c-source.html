<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Z72 MDIS Driver - z72_drv.c Source File</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Z72 MDIS Driver &nbsp; </h1>
	<h3>z72_drv.c Source File</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>z72_drv.c</h1><a href="z72__drv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
00018  <span class="comment">/*</span>
00019 <span class="comment"> * This program is free software: you can redistribute it and/or modify</span>
00020 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00021 <span class="comment"> * the Free Software Foundation, either version 2 of the License, or</span>
00022 <span class="comment"> * (at your option) any later version.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00025 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00026 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00027 <span class="comment"> * GNU General Public License for more details.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00030 <span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
00031 <span class="comment"> */</span>
00032 
00033 <span class="preprocessor">#include "<a class="code" href="z72__drv__int_8h.html">z72_drv_int.h</a>"</span>    <span class="comment">/* Z72 driver internal header file */</span>
00034 
<a name="l00035"></a><a class="code" href="z72__drv_8c.html#a0">00035</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="z72__drv_8c.html#a0">IdentString</a>[]=MENT_XSTR(MAK_REVISION);
00036 
00037 <span class="comment">/*-----------------------------------------+</span>
00038 <span class="comment">|  DEFINES                                 |</span>
00039 <span class="comment">+-----------------------------------------*/</span>
00040 <span class="comment">/* include files which need LL_HANDLE */</span>
00041 <span class="preprocessor">#include &lt;MEN/ll_entry.h&gt;</span>   <span class="comment">/* low-level driver jump table  */</span>
00042 <span class="preprocessor">#include &lt;MEN/z72_drv.h&gt;</span>   <span class="comment">/* Z72 driver header file */</span>
00043 <span class="comment">/*-----------------------------------------+</span>
00044 <span class="comment">|  PROTOTYPES                              |</span>
00045 <span class="comment">+-----------------------------------------*/</span>
00046 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a1">Z72_Init</a>(DESC_SPEC *descSpec, OSS_HANDLE *osHdl,
00047                        MACCESS *ma, OSS_SEM_HANDLE *devSemHdl,
00048                        OSS_IRQ_HANDLE *irqHdl, <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00049 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a2">Z72_Exit</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP );
00050 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a3">Z72_Read</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 *value);
00051 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a4">Z72_Write</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 value);
00052 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a5">Z72_SetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,int32 ch, int32 code, INT32_OR_64 value32_or_64);
00053 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a6">Z72_GetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 code, INT32_OR_64 *value32_or_64P);
00054 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a7">Z72_BlockRead</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00055                             int32 *nbrRdBytesP);
00056 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a8">Z72_BlockWrite</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00057                              int32 *nbrWrBytesP);
00058 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a9">Z72_Irq</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00059 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a10">Z72_Info</a>(int32 infoType, ... );
00060 
00061 <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z72__drv_8c.html#a11">Ident</a>( <span class="keywordtype">void</span> );
00062 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 retCode);
00063 
00064 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a13">readRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *buf, u_int32 numBytes );
00065 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a14">skipRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00066 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a15">readMemory</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00067                          u_int32 majState,
00068                          u_int8 *buf,
00069                          u_int16 size,
00070                          u_int16 offs );
00071 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00072 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a17">waitOnReady</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00073 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a18">getDevError</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00074 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *data, u_int32 cmd );
00075 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a20">byteCrc</a>( u_int8 *crc, u_int8 c );
00076 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a21">byteCrcFinish</a>( u_int8 *crc );
00077 <span class="keyword">static</span> u_int8 <a class="code" href="z72__drv_8c.html#a22">bufCrc8</a>( u_int8 crcStart, u_int8 *p, u_int32 len);
00078 
00079 
00080 
00081 <span class="comment">/****************************** Z72_GetEntry ********************************/</span>
<a name="l00086"></a><a class="code" href="z72__drv_8c.html#a23">00086</a> <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a23">Z72_GetEntry</a>( LL_ENTRY* drvP )
00087 {
00088     drvP-&gt;init        = <a class="code" href="z72__drv_8c.html#a1">Z72_Init</a>;
00089     drvP-&gt;exit        = <a class="code" href="z72__drv_8c.html#a2">Z72_Exit</a>;
00090     drvP-&gt;read        = <a class="code" href="z72__drv_8c.html#a3">Z72_Read</a>;
00091     drvP-&gt;write       = <a class="code" href="z72__drv_8c.html#a4">Z72_Write</a>;
00092     drvP-&gt;blockRead   = <a class="code" href="z72__drv_8c.html#a7">Z72_BlockRead</a>;
00093     drvP-&gt;blockWrite  = <a class="code" href="z72__drv_8c.html#a8">Z72_BlockWrite</a>;
00094     drvP-&gt;setStat     = <a class="code" href="z72__drv_8c.html#a5">Z72_SetStat</a>;
00095     drvP-&gt;getStat     = <a class="code" href="z72__drv_8c.html#a6">Z72_GetStat</a>;
00096     drvP-&gt;irq         = <a class="code" href="z72__drv_8c.html#a9">Z72_Irq</a>;
00097     drvP-&gt;info        = <a class="code" href="z72__drv_8c.html#a10">Z72_Info</a>;
00098 }
00099 
00100 <span class="comment">/******************************** Z72_Init **********************************/</span>
<a name="l00118"></a><a class="code" href="z72__drv_8c.html#a1">00118</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a1">Z72_Init</a>(
00119     DESC_SPEC       *descP,
00120     OSS_HANDLE      *osHdl,
00121     MACCESS         *ma,
00122     OSS_SEM_HANDLE  *devSemHdl,
00123     OSS_IRQ_HANDLE  *irqHdl,
00124     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>       **llHdlP
00125 )
00126 {
00127     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = NULL;
00128     u_int32 gotsize;
00129     int32 error;
00130     u_int32 value;
00131 
00132     <span class="comment">/*------------------------------+</span>
00133 <span class="comment">    |  prepare the handle           |</span>
00134 <span class="comment">    +------------------------------*/</span>
00135     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00136 
00137     <span class="comment">/* alloc */</span>
00138     <span class="keywordflow">if</span> ((llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)OSS_MemGet(
00139                     osHdl, <span class="keyword">sizeof</span>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>), &amp;gotsize)) == NULL)
00140        <span class="keywordflow">return</span>(ERR_OSS_MEM_ALLOC);
00141 
00142     <span class="comment">/* clear */</span>
00143     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl, 0x00);
00144 
00145     <span class="comment">/* init */</span>
00146     llHdl-&gt;memAlloc   = gotsize;
00147     llHdl-&gt;osHdl      = osHdl;
00148     llHdl-&gt;irqHdl     = irqHdl;
00149     llHdl-&gt;ma         = *ma;
00150     llHdl-&gt;devSemHdl  = devSemHdl;
00151 
00152     <span class="comment">/*------------------------------+</span>
00153 <span class="comment">    |  init id function table       |</span>
00154 <span class="comment">    +------------------------------*/</span>
00155     <span class="comment">/* driver's ident function */</span>
00156     llHdl-&gt;idFuncTbl.idCall[0].identCall = <a class="code" href="z72__drv_8c.html#a11">Ident</a>;
00157     <span class="comment">/* library's ident functions */</span>
00158     llHdl-&gt;idFuncTbl.idCall[1].identCall = DESC_Ident;
00159     llHdl-&gt;idFuncTbl.idCall[2].identCall = OSS_Ident;
00160     <span class="comment">/* terminator */</span>
00161     llHdl-&gt;idFuncTbl.idCall[3].identCall = NULL;
00162 
00163     <span class="comment">/*------------------------------+</span>
00164 <span class="comment">    |  prepare debugging            |</span>
00165 <span class="comment">    +------------------------------*/</span>
00166     llHdl-&gt;dbgLevel = OSS_DBG_DEFAULT;  <span class="comment">/* set OS specific debug level */</span>
00167     DBGINIT((NULL,&amp;<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>));
00168 
00169     <span class="comment">/*------------------------------+</span>
00170 <span class="comment">    |  prepare semaphores           |</span>
00171 <span class="comment">    +------------------------------*/</span>
00172     <span class="keywordflow">if</span>( (error = OSS_SemCreate( llHdl-&gt;osHdl, OSS_SEM_BIN,
00173                                 0, &amp;llHdl-&gt;exeSem )))
00174         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl,error) );
00175     DBGWRT_2((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"  INIT:  exeSem created whith 0\n"</span> ));
00176 
00177     <span class="comment">/*------------------------------+</span>
00178 <span class="comment">    |  scan descriptor              |</span>
00179 <span class="comment">    +------------------------------*/</span>
00180     <span class="comment">/* prepare access */</span>
00181     <span class="keywordflow">if</span> ((error = DESC_Init(descP, osHdl, &amp;llHdl-&gt;descHdl)))
00182         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl,error) );
00183 
00184     <span class="comment">/* DEBUG_LEVEL_DESC */</span>
00185     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00186                                 &amp;value, <span class="stringliteral">"DEBUG_LEVEL_DESC"</span>)) &amp;&amp;
00187         error != ERR_DESC_KEY_NOTFOUND)
00188         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl,error) );
00189 
00190     DESC_DbgLevelSet(llHdl-&gt;descHdl, value);    <span class="comment">/* set level */</span>
00191 
00192     <span class="comment">/* DEBUG_LEVEL */</span>
00193     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00194                                 &amp;llHdl-&gt;dbgLevel, <span class="stringliteral">"DEBUG_LEVEL"</span>)) &amp;&amp;
00195         error != ERR_DESC_KEY_NOTFOUND)
00196         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl, error) );
00197 
00198     llHdl-&gt;dbgLevel = DBG_ALL;
00199 
00200     <span class="comment">/* IRQ_ENABLE */</span>
00201     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 0,
00202                                 &amp;value, <span class="stringliteral">"IRQ_ENABLE"</span>)) &amp;&amp;
00203         error != ERR_DESC_KEY_NOTFOUND)
00204         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl, error) );
00205 
00206     <span class="keywordflow">if</span>( value == 0 )
00207         llHdl-&gt;mode |= <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>;
00208 
00209     <span class="comment">/* AUTO_SKIPROM */</span>
00210     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 1,
00211                                 &amp;value, <span class="stringliteral">"AUTO_SKIPROM"</span>)) &amp;&amp;
00212         error != ERR_DESC_KEY_NOTFOUND)
00213         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl, error) );
00214 
00215     <span class="keywordflow">if</span>( value == 1 )
00216         llHdl-&gt;mode |= <a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>;
00217 
00218     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Init (ma=0x%08p) in %s mode\n"</span>,
00219                     llHdl-&gt;ma,
00220                     (llHdl-&gt;mode &amp; <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>) ? <span class="stringliteral">"polled"</span> : <span class="stringliteral">"irq"</span>));
00221 
00222     <span class="comment">/*------------------------------+</span>
00223 <span class="comment">    |  init hardware                |</span>
00224 <span class="comment">    +------------------------------*/</span>
00225     <span class="comment">/* do accesses here in polled mode */</span>
00226     <a class="code" href="z72__drv_8c.html#a5">Z72_SetStat</a>(llHdl, M_MK_IRQ_ENABLE, 0, 0);
00227 
00228     <span class="keywordflow">if</span>( (error = <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( llHdl )) != ERR_SUCCESS ) {
00229         DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Init: No OWB devices present\n"</span>));
00230         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl, error) );
00231     }
00232 
00233     <span class="comment">/* enable interrupts? */</span>
00234     <span class="keywordflow">if</span>( !(llHdl-&gt;mode &amp; <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>) ) {
00235         <a class="code" href="z72__drv_8c.html#a5">Z72_SetStat</a>(llHdl, M_MK_IRQ_ENABLE, 0, 1);
00236     }
00237 
00238     *llHdlP = llHdl;    <span class="comment">/* set low-level driver handle */</span>
00239 
00240     <span class="keywordflow">return</span>(ERR_SUCCESS);
00241 }
00242 
00243 <span class="comment">/****************************** Z72_Exit ************************************/</span>
<a name="l00253"></a><a class="code" href="z72__drv_8c.html#a2">00253</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a2">Z72_Exit</a>(
00254    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>    **llHdlP
00255 )
00256 {
00257     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = *llHdlP;
00258     int32 error = 0;
00259 
00260     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Exit\n"</span>));
00261 
00262     <span class="comment">/*------------------------------+</span>
00263 <span class="comment">    |  de-init hardware             |</span>
00264 <span class="comment">    +------------------------------*/</span>
00265     <span class="comment">/* disable interrupts */</span>
00266     <a class="code" href="z72__drv_8c.html#a5">Z72_SetStat</a>(llHdl, M_MK_IRQ_ENABLE, 0, 0);
00267 
00268     <span class="comment">/*------------------------------+</span>
00269 <span class="comment">    |  clean up memory               |</span>
00270 <span class="comment">    +------------------------------*/</span>
00271     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00272     error = <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(llHdl,error);
00273 
00274     <span class="keywordflow">return</span>(error);
00275 }
00276 
00277 <span class="comment">/****************************** Z72_Read ************************************/</span>
<a name="l00286"></a><a class="code" href="z72__drv_8c.html#a3">00286</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a3">Z72_Read</a>(
00287     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00288     int32 ch,
00289     int32 *valueP
00290 )
00291 {
00292     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Read: not supported\n"</span>));
00293 
00294     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00295 }
00296 
00297 <span class="comment">/****************************** Z72_Write ***********************************/</span>
<a name="l00306"></a><a class="code" href="z72__drv_8c.html#a4">00306</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a4">Z72_Write</a>(
00307     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00308     int32 ch,
00309     int32 value
00310 )
00311 {
00312     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Write: not supported\n"</span>));
00313 
00314     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00315 }
00316 
00317 <span class="comment">/****************************** Z72_SetStat *********************************/</span>
<a name="l00331"></a><a class="code" href="z72__drv_8c.html#a5">00331</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a5">Z72_SetStat</a>(
00332     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00333     int32  code,
00334     int32  ch,
00335     INT32_OR_64 value32_or_64
00336 )
00337 {
00338     int32 value = (int32)value32_or_64;     <span class="comment">/* 32bit value */</span>
00339     <span class="comment">/* INT32_OR_64 valueP = value32_or_64;     stores 32/64bit pointer */</span>
00340     int32 error = ERR_SUCCESS;
00341     u_int8 retVal;
00342 
00343     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_SetStat: ch=%d code=0x%04x value=0x%x\n"</span>,
00344               ch,code,value));
00345 
00346     <span class="keywordflow">switch</span>(code) {
00347         <span class="comment">/*--------------------------+</span>
00348 <span class="comment">        |  debug level              |</span>
00349 <span class="comment">        +--------------------------*/</span>
00350         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00351             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a> = value;
00352             <span class="keywordflow">break</span>;
00353         <span class="comment">/*--------------------------+</span>
00354 <span class="comment">        |  enable interrupts        |</span>
00355 <span class="comment">        +--------------------------*/</span>
00356         <span class="keywordflow">case</span> M_MK_IRQ_ENABLE:
00357             retVal = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> );
00358             <span class="keywordflow">if</span>( value ) {
00359                 <span class="comment">/* reset status bits */</span>
00360                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a>,
00361                             (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) );
00362                 <span class="comment">/* enable interrupts */</span>
00363                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a>,
00364                             retVal | <a class="code" href="z72__drv__int_8h.html#a25">Z72_CTL_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a26">Z72_CTL_EIRQ</a> );
00365 
00366                 <span class="comment">/* use interrupts/semaphores to wait for ready */</span>
00367                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp;= ~<a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>;
00368             } <span class="keywordflow">else</span> {
00369                 <span class="comment">/* use polling mode to wait for ready */</span>
00370                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> |= <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>;
00371 
00372                 <span class="comment">/* disable interrupts */</span>
00373                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a>,
00374                             retVal &amp; ~(<a class="code" href="z72__drv__int_8h.html#a25">Z72_CTL_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a26">Z72_CTL_EIRQ</a>) );
00375             }
00376             <span class="keywordflow">break</span>;
00377         <span class="comment">/*--------------------------+</span>
00378 <span class="comment">        |  set irq counter          |</span>
00379 <span class="comment">        +--------------------------*/</span>
00380         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00381             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a> = value;
00382             <span class="keywordflow">break</span>;
00383 
00384         <span class="comment">/*-----------------------------+</span>
00385 <span class="comment">        |  set automatic skip ROM mode |</span>
00386 <span class="comment">        +-----------------------------*/</span>
00387         <span class="keywordflow">case</span> Z72_ROM_SKIP_AUTOEN:
00388             <span class="keywordflow">if</span>( value )
00389                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> |= <a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>;
00390             <span class="keywordflow">else</span>
00391                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp;= ~<a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>;
00392             <span class="keywordflow">break</span>;
00393 
00394         <span class="comment">/*--------------------------+</span>
00395 <span class="comment">        |  (unknown)                |</span>
00396 <span class="comment">        +--------------------------*/</span>
00397         <span class="keywordflow">default</span>:
00398             error = ERR_LL_UNK_CODE;
00399     }
00400 
00401     <span class="keywordflow">return</span>(error);
00402 }
00403 
00404 <span class="comment">/****************************** Z72_GetStat *********************************/</span>
<a name="l00420"></a><a class="code" href="z72__drv_8c.html#a6">00420</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a6">Z72_GetStat</a>(
00421     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00422     int32  code,
00423     int32  ch,
00424     INT32_OR_64 *value32_or_64P
00425 )
00426 {
00427     int32 *valueP = (int32*)value32_or_64P;             <span class="comment">/* pointer to 32bit value  */</span>
00428     INT32_OR_64 *value64P = value32_or_64P;             <span class="comment">/* stores 32/64bit pointer  */</span>
00429     <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a> *blk = (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a>*)value32_or_64P;      <span class="comment">/* stores block struct pointer */</span>
00430 
00431     int32 error = ERR_SUCCESS;
00432 
00433     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_GetStat: ch=%d code=0x%04x\n"</span>,
00434               ch,code));
00435 
00436     <span class="keywordflow">switch</span>(code)
00437     {
00438         <span class="comment">/*--------------------------+</span>
00439 <span class="comment">        |  debug level              |</span>
00440 <span class="comment">        +--------------------------*/</span>
00441         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00442             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a>;
00443             <span class="keywordflow">break</span>;
00444         <span class="comment">/*--------------------------+</span>
00445 <span class="comment">        |  number of channels       |</span>
00446 <span class="comment">        +--------------------------*/</span>
00447         <span class="keywordflow">case</span> M_LL_CH_NUMBER:
00448             *valueP = <a class="code" href="z72__drv__int_8h.html#a1">CH_NUMBER</a>;
00449             <span class="keywordflow">break</span>;
00450         <span class="comment">/*--------------------------+</span>
00451 <span class="comment">        |  channel direction        |</span>
00452 <span class="comment">        +--------------------------*/</span>
00453         <span class="keywordflow">case</span> M_LL_CH_DIR:
00454             *valueP = M_CH_INOUT;
00455             <span class="keywordflow">break</span>;
00456         <span class="comment">/*--------------------------+</span>
00457 <span class="comment">        |  channel length [bits]    |</span>
00458 <span class="comment">        +--------------------------*/</span>
00459         <span class="keywordflow">case</span> M_LL_CH_LEN:
00460             *valueP = 32;
00461             <span class="keywordflow">break</span>;
00462         <span class="comment">/*--------------------------+</span>
00463 <span class="comment">        |  channel type info        |</span>
00464 <span class="comment">        +--------------------------*/</span>
00465         <span class="keywordflow">case</span> M_LL_CH_TYP:
00466             *valueP = M_CH_BINARY;
00467             <span class="keywordflow">break</span>;
00468         <span class="comment">/*--------------------------+</span>
00469 <span class="comment">        |  irq counter              |</span>
00470 <span class="comment">        +--------------------------*/</span>
00471         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00472             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>;
00473             <span class="keywordflow">break</span>;
00474         <span class="comment">/*--------------------------+</span>
00475 <span class="comment">        |  ID PROM check enabled    |</span>
00476 <span class="comment">        +--------------------------*/</span>
00477         <span class="keywordflow">case</span> M_LL_ID_CHECK:
00478             *valueP = 0;
00479             <span class="keywordflow">break</span>;
00480         <span class="comment">/*--------------------------+</span>
00481 <span class="comment">        |   ident table pointer     |</span>
00482 <span class="comment">        |   (treat as non-block!)   |</span>
00483 <span class="comment">        +--------------------------*/</span>
00484         <span class="keywordflow">case</span> M_MK_BLK_REV_ID:
00485            *value64P = (INT32_OR_64)&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o5">idFuncTbl</a>;
00486            <span class="keywordflow">break</span>;
00487         <span class="comment">/*--------------------------+</span>
00488 <span class="comment">        |  get ROM content          |</span>
00489 <span class="comment">        +--------------------------*/</span>
00490         <span class="keywordflow">case</span> Z72_BLK_ROM_READ:
00491             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL ||
00492                 blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a> &lt; Z72_OWB_ROM_LEN )
00493             {
00494                 error = ERR_LL_ILL_PARAM;
00495                 <span class="keywordflow">break</span>;
00496             }
00497             error = <a class="code" href="z72__drv_8c.html#a13">readRom</a>( llHdl, (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a> );
00498             <span class="keywordflow">break</span>;
00499         <span class="comment">/*--------------------------+</span>
00500 <span class="comment">        |  get memory content       |</span>
00501 <span class="comment">        +--------------------------*/</span>
00502         <span class="keywordflow">case</span> Z72_BLK_MEM:
00503             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL )
00504             {
00505                 error = ERR_LL_ILL_PARAM;
00506                 <span class="keywordflow">break</span>;
00507             }
00508             error = <a class="code" href="z72__drv_8c.html#a15">readMemory</a>( llHdl, <a class="code" href="z72__drv__int_8h.html#a76a57">Z72_ST_MAJ_MEM_READ</a>,
00509                                 (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, (u_int16)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a>,
00510                                 *(u_int16*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> );
00511             <span class="keywordflow">break</span>;
00512         <span class="comment">/*------------------------------------------------+</span>
00513 <span class="comment">        |  get memory content &amp; generate CRC on each page |</span>
00514 <span class="comment">        +------------------------------------------------*/</span>
00515         <span class="keywordflow">case</span> Z72_BLK_MEM_CRC:
00516             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL )
00517             {
00518                 error = ERR_LL_ILL_PARAM;
00519                 <span class="keywordflow">break</span>;
00520             }
00521             error = <a class="code" href="z72__drv_8c.html#a15">readMemory</a>( llHdl, <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a>,
00522                                 (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, (u_int16)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a>,
00523                                 *(u_int16*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> );
00524             <span class="keywordflow">break</span>;
00525         <span class="comment">/*--------------------------+</span>
00526 <span class="comment">        |  get memory content       |</span>
00527 <span class="comment">        +--------------------------*/</span>
00528         <span class="keywordflow">case</span> Z72_BLK_STATUS:
00529             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL )
00530             {
00531                 error = ERR_LL_ILL_PARAM;
00532                 <span class="keywordflow">break</span>;
00533             }
00534             error = <a class="code" href="z72__drv_8c.html#a15">readMemory</a>( llHdl, <a class="code" href="z72__drv__int_8h.html#a76a60">Z72_ST_MAJ_STATUS_READ</a>,
00535                                 (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, (u_int16)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a>,
00536                                 *(u_int16*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> );
00537             <span class="keywordflow">break</span>;
00538         <span class="comment">/*--------------------------+</span>
00539 <span class="comment">        |  unknown                  |</span>
00540 <span class="comment">        +--------------------------*/</span>
00541         <span class="keywordflow">default</span>:
00542             error = ERR_LL_UNK_CODE;
00543     }
00544 
00545     <span class="keywordflow">return</span>(error);
00546 }
00547 
00548 <span class="comment">/******************************* Z72_BlockRead ******************************/</span>
<a name="l00559"></a><a class="code" href="z72__drv_8c.html#a7">00559</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a7">Z72_BlockRead</a>(
00560      <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00561      int32     ch,
00562      <span class="keywordtype">void</span>      *buf,
00563      int32     size,
00564      int32     *nbrRdBytesP
00565 )
00566 {
00567     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_BlockRead: not supported\n"</span>));
00568 
00569     <span class="comment">/* return number of read bytes */</span>
00570     *nbrRdBytesP = 0;
00571 
00572     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00573 }
00574 
00575 <span class="comment">/****************************** Z72_BlockWrite ******************************/</span>
<a name="l00586"></a><a class="code" href="z72__drv_8c.html#a8">00586</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a8">Z72_BlockWrite</a>(
00587      <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00588      int32     ch,
00589      <span class="keywordtype">void</span>      *buf,
00590      int32     size,
00591      int32     *nbrWrBytesP
00592 )
00593 {
00594     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_BlockWrite: not supported \n"</span>));
00595 
00596     <span class="comment">/* return number of written bytes */</span>
00597     *nbrWrBytesP = 0;
00598 
00599     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00600 }
00601 
00602 
00603 <span class="comment">/****************************** Z72_Irq ************************************/</span>
<a name="l00616"></a><a class="code" href="z72__drv_8c.html#a9">00616</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a9">Z72_Irq</a>(
00617    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
00618 )
00619 {
00620     u_int8 irqReq;
00621     IDBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z72_Irq:\n"</span>));
00622 
00623     <span class="comment">/* interrupt caused by Z72_OWB ? */</span>
00624     irqReq = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
00625 
00626     <span class="keywordflow">if</span>( irqReq &amp; (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) ) {
00627 
00628         <span class="comment">/* release interrupt */</span>
00629         MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a>,
00630                     irqReq &amp; (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) );
00631 
00632         <span class="comment">/* save status */</span>
00633         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> = irqReq;
00634 
00635         <span class="comment">/* inform waiting task */</span>
00636         OSS_SemSignal( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> );
00637 
00638         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>++;
00639         <span class="keywordflow">return</span>( LL_IRQ_DEVICE );
00640     }
00641 
00642     <span class="keywordflow">return</span>(LL_IRQ_DEV_NOT);     <span class="comment">/* say: not me */</span>
00643 }
00644 
00645 <span class="comment">/****************************** Z72_Info ***********************************/</span>
<a name="l00683"></a><a class="code" href="z72__drv_8c.html#a10">00683</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a10">Z72_Info</a>(
00684    int32  infoType,
00685    ...
00686 )
00687 {
00688     int32   error = ERR_SUCCESS;
00689     va_list argptr;
00690 
00691     va_start(argptr, infoType );
00692 
00693     <span class="keywordflow">switch</span>(infoType) {
00694         <span class="comment">/*-------------------------------+</span>
00695 <span class="comment">        |  hardware characteristics      |</span>
00696 <span class="comment">        |  (all addr/data modes ORed)   |</span>
00697 <span class="comment">        +-------------------------------*/</span>
00698         <span class="keywordflow">case</span> LL_INFO_HW_CHARACTER:
00699         {
00700             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00701             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00702 
00703             *addrModeP = MDIS_MA08;
00704             *dataModeP = MDIS_MD08 | MDIS_MD16;
00705             <span class="keywordflow">break</span>;
00706         }
00707         <span class="comment">/*-------------------------------+</span>
00708 <span class="comment">        |  nr of required address spaces |</span>
00709 <span class="comment">        |  (total spaces used)           |</span>
00710 <span class="comment">        +-------------------------------*/</span>
00711         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE_COUNT:
00712         {
00713             u_int32 *nbrOfAddrSpaceP = va_arg(argptr, u_int32*);
00714 
00715             *nbrOfAddrSpaceP = <a class="code" href="z72__drv__int_8h.html#a3">ADDRSPACE_COUNT</a>;
00716             <span class="keywordflow">break</span>;
00717         }
00718         <span class="comment">/*-------------------------------+</span>
00719 <span class="comment">        |  address space type            |</span>
00720 <span class="comment">        |  (widest used data mode)       |</span>
00721 <span class="comment">        +-------------------------------*/</span>
00722         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE:
00723         {
00724             u_int32 addrSpaceIndex = va_arg(argptr, u_int32);
00725             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00726             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00727             u_int32 *addrSizeP = va_arg(argptr, u_int32*);
00728 
00729             <span class="keywordflow">if</span> (addrSpaceIndex &gt;= <a class="code" href="z72__drv__int_8h.html#a3">ADDRSPACE_COUNT</a>)
00730                 error = ERR_LL_ILL_PARAM;
00731             <span class="keywordflow">else</span> {
00732                 *addrModeP = MDIS_MA08;
00733                 *dataModeP = MDIS_MD16;
00734                 *addrSizeP = <a class="code" href="z72__drv__int_8h.html#a4">ADDRSPACE_SIZE</a>;
00735             }
00736 
00737             <span class="keywordflow">break</span>;
00738         }
00739         <span class="comment">/*-------------------------------+</span>
00740 <span class="comment">        |   interrupt required           |</span>
00741 <span class="comment">        +-------------------------------*/</span>
00742         <span class="keywordflow">case</span> LL_INFO_IRQ:
00743         {
00744             u_int32 *useIrqP = va_arg(argptr, u_int32*);
00745 
00746             *useIrqP = <a class="code" href="z72__drv__int_8h.html#a2">USE_IRQ</a>;
00747             <span class="keywordflow">break</span>;
00748         }
00749         <span class="comment">/*-------------------------------+</span>
00750 <span class="comment">        |   process lock mode            |</span>
00751 <span class="comment">        +-------------------------------*/</span>
00752         <span class="keywordflow">case</span> LL_INFO_LOCKMODE:
00753         {
00754             u_int32 *lockModeP = va_arg(argptr, u_int32*);
00755 
00756             *lockModeP = LL_LOCK_CALL;
00757             <span class="keywordflow">break</span>;
00758         }
00759         <span class="comment">/*-------------------------------+</span>
00760 <span class="comment">        |   (unknown)                    |</span>
00761 <span class="comment">        +-------------------------------*/</span>
00762         <span class="keywordflow">default</span>:
00763           error = ERR_LL_ILL_PARAM;
00764     }
00765 
00766     va_end(argptr);
00767     <span class="keywordflow">return</span>(error);
00768 }
00769 
00770 <span class="comment">/*******************************  Ident  ***********************************/</span>
<a name="l00775"></a><a class="code" href="z72__drv_8c.html#a11">00775</a> <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z72__drv_8c.html#a11">Ident</a>( <span class="keywordtype">void</span> )
00776 {
00777     <span class="keywordflow">return</span>( (<span class="keywordtype">char</span>*) <a class="code" href="z72__drv_8c.html#a0">IdentString</a> );
00778 }
00779 
00780 <span class="comment">/********************************* Cleanup *********************************/</span>
<a name="l00790"></a><a class="code" href="z72__drv_8c.html#a12">00790</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a12">Cleanup</a>(
00791    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>    *llHdl,
00792    int32        retCode
00793 )
00794 {
00795     <span class="comment">/*------------------------------+</span>
00796 <span class="comment">    |  close handles                |</span>
00797 <span class="comment">    +------------------------------*/</span>
00798     <span class="comment">/* clean up desc */</span>
00799     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>)
00800         DESC_Exit(&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>);
00801 
00802     <span class="comment">/* clean up semaphores */</span>
00803     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> != NULL)
00804         OSS_SemRemove( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> );
00805 
00806     <span class="comment">/* clean up debug */</span>
00807     DBGEXIT((&amp;<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>));
00808 
00809     <span class="comment">/*------------------------------+</span>
00810 <span class="comment">    |  free memory                  |</span>
00811 <span class="comment">    +------------------------------*/</span>
00812     <span class="comment">/* free my handle */</span>
00813     OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, (int8*)llHdl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o0">memAlloc</a>);
00814 
00815     <span class="comment">/*------------------------------+</span>
00816 <span class="comment">    |  return error code            |</span>
00817 <span class="comment">    +------------------------------*/</span>
00818     <span class="keywordflow">return</span>(retCode);
00819 }
00820 
00821 <span class="comment">/********************************* readRom *********************************/</span>
<a name="l00833"></a><a class="code" href="z72__drv_8c.html#a13">00833</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a13">readRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *buf, u_int32 numBytes )
00834 {
00835     int32 error = ERR_SUCCESS;
00836     u_int32 i;
00837     u_int8 owbCmd;
00838     <span class="comment">/* initialize crc */</span>
00839     u_int8 crc;
00840 
00841     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readRom\n"</span>));
00842 
00843     <span class="keywordflow">if</span>( numBytes &lt; Z72_OWB_ROM_LEN ) {
00844         error = ERR_LL_ILL_PARAM;
00845         <span class="keywordflow">goto</span> CLEANUP;
00846     }
00847 
00848     <span class="comment">/* do Reset/Presence Pulse Cycle */</span>
00849     <span class="keywordflow">if</span>( (error = <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( llHdl )) != ERR_SUCCESS )
00850         <span class="keywordflow">goto</span> CLEANUP;
00851 
00852     <span class="comment">/* send command */</span>
00853     owbCmd = <a class="code" href="group____Z72__DS2502.html#a4">Z72_OWB_ROM_READ</a>;
00854     <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
00855 
00856     <span class="keywordflow">for</span>( i = 0; error == ERR_SUCCESS &amp;&amp; i &lt; Z72_OWB_ROM_LEN; i++) {
00857         error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;buf[i], <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
00858     }
00859 
00860     DBGWRT_4(( <a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"\nZ72_ROM: Family: 0x%02x\n"</span>
00861                     <span class="stringliteral">"         Serial: 0x%02x     0x%02x\n"</span>,
00862                     buf[0], buf[1], buf[2] ));
00863     <span class="keywordflow">for</span>( i = 3; i &lt; Z72_OWB_ROM_LEN - 1; i+=2) {
00864         DBGWRT_4(( <a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"                 0x%02x     0x%02x\n"</span>,
00865                         buf[i], buf[i+1] ));
00866     }
00867     DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"            CRC: 0x%02x\n"</span>, buf[Z72_OWB_ROM_LEN - 1] ));
00868 
00869     crc = <a class="code" href="z72__drv_8c.html#a22">bufCrc8</a>( <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>, buf, 7 );
00870     <span class="keywordflow">if</span>( crc != buf[Z72_OWB_ROM_LEN - 1] ) {
00871         DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"LL - Z72_OWB readRom: CRC is 0x%02x; sb 0x%02x\n"</span>,
00872                         crc, buf[Z72_OWB_ROM_LEN - 1] ));
00873         error = Z72_ERR_CRC;
00874         <span class="keywordflow">goto</span> CLEANUP;
00875     }
00876 
00877     <span class="keywordflow">if</span>( error ) {
00878         <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( llHdl );
00879     } <span class="keywordflow">else</span> {
00880         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = <a class="code" href="z72__drv__int_8h.html#a76a56">Z72_ST_MAJ_IDLE_MEM</a>;
00881     }
00882 
00883 CLEANUP:
00884     <span class="keywordflow">return</span> error;
00885 }
00886 
00887 <span class="comment">/********************************* readRom ***********************************/</span>
<a name="l00894"></a><a class="code" href="z72__drv_8c.html#a14">00894</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a14">skipRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
00895 {
00896     int32 error   = ERR_LL_ILL_FUNC;
00897     u_int8 owbCmd;
00898     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB skipRom\n"</span>));
00899 
00900     <span class="comment">/* do Reset/Presence Pulse Cycle */</span>
00901     <span class="keywordflow">if</span>( (error = <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( llHdl )) != ERR_SUCCESS )
00902         <span class="keywordflow">goto</span> CLEANUP;
00903 
00904     owbCmd = <a class="code" href="group____Z72__DS2502.html#a7">Z72_OWB_ROM_SKIP</a>;
00905     error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
00906 
00907     <span class="keywordflow">if</span>( error ) {
00908         <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( llHdl );
00909     } <span class="keywordflow">else</span> {
00910         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = <a class="code" href="z72__drv__int_8h.html#a76a56">Z72_ST_MAJ_IDLE_MEM</a>;
00911     }
00912 
00913 CLEANUP:
00914     <span class="keywordflow">return</span>( error );
00915 }
00916 
00917 <span class="comment">/********************************* readMemory ********************************/</span>
<a name="l00931"></a><a class="code" href="z72__drv_8c.html#a15">00931</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a15">readMemory</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00932                          u_int32 majState,
00933                          u_int8 *buf,
00934                          u_int16 size,
00935                          u_int16 offs )
00936 {
00937     int32 error = ERR_SUCCESS;
00938     u_int32 rdIdx = 0;
00939     u_int8 owbCmd, rdVal = 0, crc;
00940 
00941     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory start=0x%04x len=0x%04x\n"</span>,
00942                     offs, size));
00943 
00944     <span class="keywordflow">if</span>( size &lt;= 0 )
00945         <span class="keywordflow">goto</span> CLEANUP;
00946 
00947     <span class="keywordflow">if</span>( offs &gt;= Z72_OWB_DS2502_MEM_SIZE ){
00948         error = Z72_ERR_BEYOND_MEM;
00949         <span class="keywordflow">goto</span> CLEANUP;
00950     }
00951 
00952     <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> != <a class="code" href="z72__drv__int_8h.html#a76a56">Z72_ST_MAJ_IDLE_MEM</a> &amp;&amp;
00953         ( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> != <a class="code" href="z72__drv__int_8h.html#a76a50">Z72_ST_MAJ_IDLE</a> ||
00954           !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp; <a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>) ||
00955           (error = <a class="code" href="z72__drv_8c.html#a14">skipRom</a>( llHdl )) != ERR_SUCCESS) )
00956     {
00957         <span class="comment">/* !IDLE_MEM &amp; (!IDLE | !AUTO_SKIPROM | skipRom() != SUCC ) */</span>
00958         <span class="keywordflow">if</span>( error == ERR_SUCCESS )
00959             error = Z72_ERR_NO_ROMFKT;
00960         <span class="keywordflow">goto</span> CLEANUP;
00961     }
00962 
00963     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = majState;
00964     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a63">Z72_ST_RX_CMD</a>;
00965 
00966     <span class="keywordflow">do</span>{
00967         DBGWRT_3((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory state %d\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> ));
00968         <span class="keywordflow">switch</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> )
00969         {
00970             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a63">Z72_ST_RX_CMD</a> ):
00971             {
00972                 <span class="keywordflow">switch</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> )
00973                 {
00974                     <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a76a57">Z72_ST_MAJ_MEM_READ</a> ):
00975                         owbCmd = <a class="code" href="group____Z72__DS2502.html#a8">Z72_OWB_DS2502_MEM_READ</a>;
00976                         <span class="keywordflow">break</span>;
00977                     <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a> ):
00978                         owbCmd = <a class="code" href="group____Z72__DS2502.html#a9">Z72_OWB_DS2502_MEM_READ_CRC</a>;
00979                         <span class="keywordflow">break</span>;
00980                     <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a76a60">Z72_ST_MAJ_STATUS_READ</a> ):
00981                         owbCmd = <a class="code" href="group____Z72__DS2502.html#a11">Z72_OWB_DS2502_STATUS_READ</a>;
00982                         <span class="keywordflow">break</span>;
00983                     <span class="keywordflow">default</span>:
00984                         error = ERR_LL_ILL_PARAM;
00985                         <span class="keywordflow">goto</span> CLEANUP;
00986                 }
00987                 error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
00988                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
00989                     <span class="keywordflow">goto</span> CLEANUP;
00990 
00991                 crc = <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>;
00992                 <a class="code" href="z72__drv_8c.html#a20">byteCrc</a>( &amp;crc, owbCmd );
00993 
00994                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a64">Z72_ST_RX_TA</a>;
00995                 <span class="keywordflow">break</span>;
00996             }
00997             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a64">Z72_ST_RX_TA</a> ):
00998             {
00999                 owbCmd = (u_int8)(offs &amp; 0x00ff);
01000                 error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
01001                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01002                     <span class="keywordflow">goto</span> CLEANUP;
01003 
01004                 <a class="code" href="z72__drv_8c.html#a20">byteCrc</a>( &amp;crc, owbCmd );
01005 
01006                 owbCmd = (u_int8)((offs &amp; 0xff00) &gt;&gt; 8);
01007                 error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
01008                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01009                     <span class="keywordflow">goto</span> CLEANUP;
01010 
01011                 <a class="code" href="z72__drv_8c.html#a20">byteCrc</a>( &amp;crc, owbCmd );
01012                 <a class="code" href="z72__drv_8c.html#a21">byteCrcFinish</a>( &amp;crc );
01013 
01014                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a65">Z72_ST_RX_CRC1</a>;
01015                 <span class="keywordflow">break</span>;
01016             }
01017             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a65">Z72_ST_RX_CRC1</a> ):
01018             {
01019                 <span class="comment">/* read CRC of command and address */</span>
01020                 error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;rdVal, <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
01021                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01022                     <span class="keywordflow">goto</span> CLEANUP;
01023 
01024                 <span class="keywordflow">if</span>( crc != rdVal ) {
01025                     error = Z72_ERR_CRC;
01026                     DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"LL - Z72_OWB readMemory: command/addr CRC "</span>
01027                                     <span class="stringliteral">"is 0x%02x; sb 0x%02x\n"</span>, crc, rdVal ));
01028                     <span class="keywordflow">goto</span> CLEANUP;
01029                 }
01030 
01031                 <span class="keywordflow">if</span>( error != ERR_SUCCESS ) <span class="comment">/* CRC error ? */</span>
01032                     <span class="keywordflow">goto</span> CLEANUP;
01033 
01034                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a>;
01035                 crc = <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>;
01036                 <span class="keywordflow">break</span>;
01037             }
01038             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a> ):
01039             {
01040                 error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;rdVal, <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
01041                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01042                     <span class="keywordflow">goto</span> CLEANUP;
01043 
01044                 buf[rdIdx] = rdVal;
01045                 size -= 1;
01046 
01047                 <a class="code" href="z72__drv_8c.html#a20">byteCrc</a>( &amp;crc, rdVal );
01048 
01049                 DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory: "</span>
01050                                <span class="stringliteral">"rdIdx 0x%04x: rdVal=0x%02x    crc=0x%02x\n"</span>,
01051                                 rdIdx, rdVal, crc ));
01052 
01053                 <span class="comment">/* read memory and</span>
01054 <span class="comment">                 * reached end of data memory? */</span>
01055                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a57">Z72_ST_MAJ_MEM_READ</a> )
01056                 {
01057                     <span class="keywordflow">if</span>( (rdIdx + offs) == (Z72_OWB_DS2502_MEM_SIZE - 1)) {
01058                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a>;
01059                         <a class="code" href="z72__drv_8c.html#a21">byteCrcFinish</a>( &amp;crc );
01060                         <span class="keywordflow">break</span>;
01061                     }
01062                 }
01063 
01064                 <span class="comment">/* read memory &amp; generate CRC and</span>
01065 <span class="comment">                 * reached end of memory page?     */</span>
01066                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a> )
01067                 {
01068                     <span class="keywordflow">if</span>( !((rdIdx + offs + 1) % Z72_OWB_DS2502_MEM_PAGESIZE)) {
01069                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a>;
01070                         <a class="code" href="z72__drv_8c.html#a21">byteCrcFinish</a>( &amp;crc );
01071                         rdIdx++;
01072                         <span class="keywordflow">break</span>;
01073                     }
01074                 }
01075 
01076                 <span class="comment">/* read status and</span>
01077 <span class="comment">                 * reached end of status page? */</span>
01078                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a60">Z72_ST_MAJ_STATUS_READ</a> )
01079                 {
01080                     <span class="keywordflow">if</span>( (rdIdx + offs) == (Z72_OWB_DS2502_ST_SIZE - 1)) {
01081                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a>;
01082                         <a class="code" href="z72__drv_8c.html#a21">byteCrcFinish</a>( &amp;crc );
01083                         <span class="keywordflow">break</span>;
01084                     }
01085                 }
01086 
01087                 <span class="comment">/* reached desired size before end of memory/status */</span>
01088                 <span class="keywordflow">if</span>( !size )
01089                     <span class="keywordflow">goto</span> CLEANUP;
01090 
01091                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a>; <span class="comment">/* stay and read more */</span>
01092                 rdIdx++;
01093                 <span class="keywordflow">break</span>;
01094             }
01095             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a> ):
01096             {
01097                 <span class="comment">/* read CRC of data */</span>
01098                 error = <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, &amp;rdVal, <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
01099 
01100                 <span class="keywordflow">if</span>( error == ERR_SUCCESS &amp;&amp; crc != rdVal ) {
01101                     error = Z72_ERR_CRC;
01102                     DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"LL - Z72_OWB readMemory: data CRC "</span>
01103                                     <span class="stringliteral">"is 0x%02x; sb 0x%02x\n"</span>, crc, rdVal ));
01104                 }
01105 
01106                 <span class="comment">/* computed crc of last page? If not, read next page     */</span>
01107                 <span class="keywordflow">if</span>( error == ERR_SUCCESS &amp;&amp;
01108                     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a> &amp;&amp;
01109                     (rdIdx + offs) != Z72_OWB_DS2502_MEM_SIZE )
01110                 {
01111                     <span class="comment">/* start reading next page */</span>
01112                     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a>;
01113                     crc = <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>;
01114                     <span class="keywordflow">break</span>;
01115                 }
01116 
01117                 <span class="comment">/* finished */</span>
01118                 <span class="keywordflow">goto</span> CLEANUP;
01119             }
01120             <span class="keywordflow">default</span>:
01121                 error = Z72_ERR_UNDEF_STATE;
01122                 <span class="keywordflow">goto</span> CLEANUP;
01123         }
01124 
01125     } <span class="keywordflow">while</span> ( !error );
01126 
01127 
01128 CLEANUP:
01129     DBGWRT_2((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory finish (error = 0x%04x)\n"</span>,error));
01130     <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( llHdl );
01131     <span class="keywordflow">return</span> error;
01132 }
01133 
01134 <span class="comment">/********************************* masterTxReset *****************************/</span>
<a name="l01141"></a><a class="code" href="z72__drv_8c.html#a16">01141</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a16">masterTxReset</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
01142 {
01143     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = <a class="code" href="z72__drv__int_8h.html#a76a50">Z72_ST_MAJ_IDLE</a>;
01144     <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( llHdl, NULL, <a class="code" href="z72__drv__int_8h.html#a20">Z72_CTL_CMD_RPP</a> ) );
01145 }
01146 
01147 <span class="comment">/********************************* waitOnReady *******************************/</span>
<a name="l01154"></a><a class="code" href="z72__drv_8c.html#a17">01154</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a17">waitOnReady</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
01155 {
01156     int32 error = ERR_SUCCESS;
01157 
01158     <span class="keywordflow">if</span>( !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp; <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>) &amp;&amp;
01159         (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> != NULL) )
01160     {
01161         <span class="comment">/* Note: signals are ignored here */</span>
01162         <span class="keywordflow">do</span> {
01163             DBGCMD( u_int8 ctl );
01164             DBGCMD( u_int8 sts );
01165 
01166             error = OSS_SemWait( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a>, <a class="code" href="z72__drv__int_8h.html#a7">Z72_SEM_TOUT</a> );
01167 
01168             DBGCMD( ctl = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> ) );
01169             DBGCMD( sts = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> ) );
01170             DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB waitOnReady(Sem) finish "</span>
01171                            <span class="stringliteral">"(error = 0x%04x) ctl=0x%02x sts=0x%02x\n"</span>,
01172                            error, ctl, sts));
01173         } <span class="keywordflow">while</span>( error==ERR_OSS_SIG_OCCURED );
01174     } <span class="keywordflow">else</span>
01175     {
01176         u_int8 sts;
01177         u_int32 retryCnt = <a class="code" href="z72__drv__int_8h.html#a6">Z72_POLL_RETRY_MAX</a>;
01178         DBGCMD( u_int8 ctl );
01179 
01180         <span class="keywordflow">do</span>{
01181             OSS_Delay( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, <a class="code" href="z72__drv__int_8h.html#a5">Z72_POLL_TOUT</a> );
01182             sts = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01183         } <span class="keywordflow">while</span>( (sts &amp; <a class="code" href="z72__drv__int_8h.html#a33">Z72_STS_BUSY</a>) &amp;&amp; retryCnt );
01184         <span class="comment">/* save status */</span>
01185         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01186 
01187         DBGCMD( ctl = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> ));
01188         DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB waitOnReady(Delay) finish "</span>
01189                        <span class="stringliteral">"(error = 0x%04x) ctl=0x%02x sts=0x%02x\n"</span>,
01190                        error, ctl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> ));
01191 
01192 
01193         <span class="comment">/* reset status bits */</span>
01194         MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a>,
01195                     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> &amp; (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) );
01196     }
01197     <span class="keywordflow">return</span> error;
01198 }
01199 
01200 <span class="comment">/********************************* getDevError *******************************/</span>
<a name="l01207"></a><a class="code" href="z72__drv_8c.html#a18">01207</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a18">getDevError</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
01208 {
01209     int32 error = ERR_SUCCESS;
01210 
01211     <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> &amp; ( <a class="code" href="z72__drv__int_8h.html#a27">Z72_STS_EEXE</a> | <a class="code" href="z72__drv__int_8h.html#a28">Z72_STS_ERPP</a> ) )
01212         error = Z72_ERR_NO_DEVICE;
01213     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> &amp; ( <a class="code" href="z72__drv__int_8h.html#a29">Z72_STS_EPP1</a> | <a class="code" href="z72__drv__int_8h.html#a30">Z72_STS_EPP2</a>) )
01214         error = Z72_ERR_PGM;
01215     <span class="keywordflow">return</span> error;
01216 }
01217 
01218 <span class="comment">/********************************* execCmd ***********************************/</span>
<a name="l01227"></a><a class="code" href="z72__drv_8c.html#a19">01227</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a19">execCmd</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *data, u_int32 cmd )
01228 {
01229     int32 error = ERR_SUCCESS;
01230     u_int8 ctlReg, stsReg, tryCnt = 0;
01231 
01232     stsReg = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01233 
01234     <span class="keywordflow">while</span>( (stsReg &amp; <a class="code" href="z72__drv__int_8h.html#a33">Z72_STS_BUSY</a>) &amp;&amp;
01235            (tryCnt++ &lt; <a class="code" href="z72__drv__int_8h.html#a8">Z72_RETRY_MAX</a>) ){
01236         OSS_Delay( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, <a class="code" href="z72__drv__int_8h.html#a5">Z72_POLL_TOUT</a> );
01237         stsReg = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01238     }
01239 
01240     <span class="keywordflow">if</span>( tryCnt &gt;= <a class="code" href="z72__drv__int_8h.html#a8">Z72_RETRY_MAX</a> ) {
01241         error = Z72_ERR_BUSY;
01242         <span class="keywordflow">goto</span> CLEANUP;
01243     }
01244 
01245     <span class="keywordflow">if</span>( cmd == <a class="code" href="z72__drv__int_8h.html#a18">Z72_CTL_CMD_WBIT</a> ||
01246         cmd == <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> )
01247     {
01248         MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a13">Z72_REG_WRT</a>, *data );
01249     }
01250 
01251     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> = 0;
01252 
01253     ctlReg = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> ) &amp; ~<a class="code" href="z72__drv__int_8h.html#a17">Z72_CTL_CMD_MASK</a>;
01254     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a>, ctlReg | (u_int8)cmd | <a class="code" href="z72__drv__int_8h.html#a24">Z72_CTL_EXEC</a> );
01255 
01256     error = <a class="code" href="z72__drv_8c.html#a17">waitOnReady</a>( llHdl );
01257 
01258     <span class="keywordflow">if</span>( error ||
01259         (error = <a class="code" href="z72__drv_8c.html#a18">getDevError</a>( llHdl )) != ERR_SUCCESS )
01260     {
01261         <span class="keywordflow">goto</span> CLEANUP;
01262     }
01263 
01264     <span class="keywordflow">if</span>( cmd == <a class="code" href="z72__drv__int_8h.html#a19">Z72_CTL_CMD_RBIT</a> ||
01265         cmd == <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> )
01266     {
01267         *data = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a14">Z72_REG_RD</a> );
01268     }
01269 
01270 CLEANUP:
01271     <span class="keywordflow">return</span> error;
01272 }
01273 
01274 <span class="comment">/* CRC subroutines */</span>
01275 
01276 <span class="comment">/********************************* reflectByte *******************************/</span>
<a name="l01283"></a><a class="code" href="z72__drv_8c.html#a24">01283</a> <span class="keyword">static</span> u_int8 <a class="code" href="z72__drv_8c.html#a24">reflectByte</a> ( u_int8 c )
01284 {
01285     <span class="comment">/* reflects the Byte c */</span>
01286     u_int32 i, j = 1;
01287     u_int8 cout = 0;
01288 
01289     <span class="keywordflow">for</span>( i = 0x80; i; i &gt;&gt;= 1) {
01290         <span class="keywordflow">if</span>( c &amp; i )
01291             cout |= j;
01292         j &lt;&lt;= 1;
01293     }
01294     <span class="keywordflow">return</span>( cout );
01295 }
01296 
01297 <span class="comment">/********************************* byteCrc ***********************************/</span>
<a name="l01303"></a><a class="code" href="z72__drv_8c.html#a20">01303</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a20">byteCrc</a>( u_int8 *crc, u_int8 c )
01304 {
01305     u_int32 j;
01306     u_int8 bit;
01307 
01308     c = <a class="code" href="z72__drv_8c.html#a24">reflectByte</a>( c );
01309 
01310     <span class="keywordflow">for</span>( j = 0x80; j; j &gt;&gt;= 1)
01311     {
01312         bit = *crc &amp; <a class="code" href="group____Z72__DS2502.html#a1">Z72_OWB_ROMCRC_HIGHBIT</a>;
01313         *crc &lt;&lt;= 1;
01314         <span class="keywordflow">if</span>( c &amp; j )
01315             *crc |= 1;
01316         <span class="keywordflow">if</span>( bit )
01317             *crc ^= <a class="code" href="group____Z72__DS2502.html#a2">Z72_OWB_ROMCRC_POLY</a>;
01318     }
01319 }
01320 
01321 <span class="comment">/********************************* byteCrcFinish *****************************/</span>
<a name="l01326"></a><a class="code" href="z72__drv_8c.html#a21">01326</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a21">byteCrcFinish</a>( u_int8 *crc )
01327 {
01328     u_int32 i;
01329     u_int8 bit;
01330 
01331     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="group____Z72__DS2502.html#a0">Z72_OWB_ROMCRC_ORDER</a>; i++)
01332     {
01333         bit = *crc &amp; <a class="code" href="group____Z72__DS2502.html#a1">Z72_OWB_ROMCRC_HIGHBIT</a>;
01334         *crc &lt;&lt;= 1;
01335         <span class="keywordflow">if</span>( bit )
01336             *crc ^= <a class="code" href="group____Z72__DS2502.html#a2">Z72_OWB_ROMCRC_POLY</a>;
01337     }
01338     *crc = <a class="code" href="z72__drv_8c.html#a24">reflectByte</a>( *crc );
01339 }
01340 
01341 <span class="comment">/********************************* bufCrc8 ***********************************/</span>
<a name="l01350"></a><a class="code" href="z72__drv_8c.html#a22">01350</a> <span class="keyword">static</span> u_int8 <a class="code" href="z72__drv_8c.html#a22">bufCrc8</a>( u_int8 crcStart, u_int8 *buf, u_int32 len)
01351 {
01352     u_int32 i;
01353     u_int8 crc = crcStart;
01354 
01355     <span class="keywordflow">for</span>( i = 0; i &lt; len; i++)
01356     {
01357         <a class="code" href="z72__drv_8c.html#a20">byteCrc</a>( &amp;crc, *buf++ );
01358     }
01359 
01360     <a class="code" href="z72__drv_8c.html#a21">byteCrcFinish</a>( &amp;crc );
01361     <span class="keywordflow">return</span>(crc);
01362 }
01363 
01364 
01365 
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Z72 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

