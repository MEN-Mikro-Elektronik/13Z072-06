<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Z72 MDIS Driver - z72_drv.c Source File</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Z72 MDIS Driver &nbsp; </h1>
	<h3>z72_drv.c Source File</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>z72_drv.c</h1><a href="z72__drv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
00018  <span class="comment">/*</span>
00019 <span class="comment"> * This program is free software: you can redistribute it and/or modify</span>
00020 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00021 <span class="comment"> * the Free Software Foundation, either version 2 of the License, or</span>
00022 <span class="comment"> * (at your option) any later version.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00025 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00026 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00027 <span class="comment"> * GNU General Public License for more details.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00030 <span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
00031 <span class="comment"> */</span>
00032 
00033 <span class="preprocessor">#include "<a class="code" href="z72__drv__int_8h.html">z72_drv_int.h</a>"</span>    <span class="comment">/* Z72 driver internal header file */</span>
00034 
00035 <span class="comment">/*-----------------------------------------+</span>
00036 <span class="comment">|  DEFINES                                 |</span>
00037 <span class="comment">+-----------------------------------------*/</span>
00038 <span class="comment">/* include files which need LL_HANDLE */</span>
00039 <span class="preprocessor">#include &lt;MEN/ll_entry.h&gt;</span>   <span class="comment">/* low-level driver jump table  */</span>
00040 <span class="preprocessor">#include &lt;MEN/z72_drv.h&gt;</span>   <span class="comment">/* Z72 driver header file */</span>
00041 <span class="comment">/*-----------------------------------------+</span>
00042 <span class="comment">|  PROTOTYPES                              |</span>
00043 <span class="comment">+-----------------------------------------*/</span>
00044 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a0">Z72_Init</a>(DESC_SPEC *descSpec, OSS_HANDLE *osHdl,
00045                        MACCESS *ma, OSS_SEM_HANDLE *devSemHdl,
00046                        OSS_IRQ_HANDLE *irqHdl, <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00047 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a1">Z72_Exit</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP );
00048 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a2">Z72_Read</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 *value);
00049 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a3">Z72_Write</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 value);
00050 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a4">Z72_SetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,int32 ch, int32 code, INT32_OR_64 value32_or_64);
00051 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a5">Z72_GetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 code, INT32_OR_64 *value32_or_64P);
00052 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a6">Z72_BlockRead</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00053                             int32 *nbrRdBytesP);
00054 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a7">Z72_BlockWrite</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00055                              int32 *nbrWrBytesP);
00056 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a8">Z72_Irq</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00057 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a9">Z72_Info</a>(int32 infoType, ... );
00058 
00059 <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z72__drv_8c.html#a10">Ident</a>( <span class="keywordtype">void</span> );
00060 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 retCode);
00061 
00062 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a12">readRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *buf, u_int32 numBytes );
00063 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a13">skipRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00064 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a14">readMemory</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00065                          u_int32 majState,
00066                          u_int8 *buf,
00067                          u_int16 size,
00068                          u_int16 offs );
00069 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00070 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a16">waitOnReady</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00071 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a17">getDevError</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl );
00072 <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *data, u_int32 cmd );
00073 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a19">byteCrc</a>( u_int8 *crc, u_int8 c );
00074 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a20">byteCrcFinish</a>( u_int8 *crc );
00075 <span class="keyword">static</span> u_int8 <a class="code" href="z72__drv_8c.html#a21">bufCrc8</a>( u_int8 crcStart, u_int8 *p, u_int32 len);
00076 
00077 
00078 
00079 <span class="comment">/****************************** Z72_GetEntry ********************************/</span>
<a name="l00084"></a><a class="code" href="z72__drv_8c.html#a22">00084</a> <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a22">Z72_GetEntry</a>( LL_ENTRY* drvP )
00085 {
00086     drvP-&gt;init        = <a class="code" href="z72__drv_8c.html#a0">Z72_Init</a>;
00087     drvP-&gt;exit        = <a class="code" href="z72__drv_8c.html#a1">Z72_Exit</a>;
00088     drvP-&gt;read        = <a class="code" href="z72__drv_8c.html#a2">Z72_Read</a>;
00089     drvP-&gt;write       = <a class="code" href="z72__drv_8c.html#a3">Z72_Write</a>;
00090     drvP-&gt;blockRead   = <a class="code" href="z72__drv_8c.html#a6">Z72_BlockRead</a>;
00091     drvP-&gt;blockWrite  = <a class="code" href="z72__drv_8c.html#a7">Z72_BlockWrite</a>;
00092     drvP-&gt;setStat     = <a class="code" href="z72__drv_8c.html#a4">Z72_SetStat</a>;
00093     drvP-&gt;getStat     = <a class="code" href="z72__drv_8c.html#a5">Z72_GetStat</a>;
00094     drvP-&gt;irq         = <a class="code" href="z72__drv_8c.html#a8">Z72_Irq</a>;
00095     drvP-&gt;info        = <a class="code" href="z72__drv_8c.html#a9">Z72_Info</a>;
00096 }
00097 
00098 <span class="comment">/******************************** Z72_Init **********************************/</span>
<a name="l00116"></a><a class="code" href="z72__drv_8c.html#a0">00116</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a0">Z72_Init</a>(
00117     DESC_SPEC       *descP,
00118     OSS_HANDLE      *osHdl,
00119     MACCESS         *ma,
00120     OSS_SEM_HANDLE  *devSemHdl,
00121     OSS_IRQ_HANDLE  *irqHdl,
00122     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>       **llHdlP
00123 )
00124 {
00125     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = NULL;
00126     u_int32 gotsize;
00127     int32 error;
00128     u_int32 value;
00129 
00130     <span class="comment">/*------------------------------+</span>
00131 <span class="comment">    |  prepare the handle           |</span>
00132 <span class="comment">    +------------------------------*/</span>
00133     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00134 
00135     <span class="comment">/* alloc */</span>
00136     <span class="keywordflow">if</span> ((llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)OSS_MemGet(
00137                     osHdl, <span class="keyword">sizeof</span>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>), &amp;gotsize)) == NULL)
00138        <span class="keywordflow">return</span>(ERR_OSS_MEM_ALLOC);
00139 
00140     <span class="comment">/* clear */</span>
00141     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl, 0x00);
00142 
00143     <span class="comment">/* init */</span>
00144     llHdl-&gt;memAlloc   = gotsize;
00145     llHdl-&gt;osHdl      = osHdl;
00146     llHdl-&gt;irqHdl     = irqHdl;
00147     llHdl-&gt;ma         = *ma;
00148     llHdl-&gt;devSemHdl  = devSemHdl;
00149 
00150     <span class="comment">/*------------------------------+</span>
00151 <span class="comment">    |  init id function table       |</span>
00152 <span class="comment">    +------------------------------*/</span>
00153     <span class="comment">/* driver's ident function */</span>
00154     llHdl-&gt;idFuncTbl.idCall[0].identCall = <a class="code" href="z72__drv_8c.html#a10">Ident</a>;
00155     <span class="comment">/* library's ident functions */</span>
00156     llHdl-&gt;idFuncTbl.idCall[1].identCall = DESC_Ident;
00157     llHdl-&gt;idFuncTbl.idCall[2].identCall = OSS_Ident;
00158     <span class="comment">/* terminator */</span>
00159     llHdl-&gt;idFuncTbl.idCall[3].identCall = NULL;
00160 
00161     <span class="comment">/*------------------------------+</span>
00162 <span class="comment">    |  prepare debugging            |</span>
00163 <span class="comment">    +------------------------------*/</span>
00164     llHdl-&gt;dbgLevel = OSS_DBG_DEFAULT;  <span class="comment">/* set OS specific debug level */</span>
00165     DBGINIT((NULL,&amp;<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>));
00166 
00167     <span class="comment">/*------------------------------+</span>
00168 <span class="comment">    |  prepare semaphores           |</span>
00169 <span class="comment">    +------------------------------*/</span>
00170     <span class="keywordflow">if</span>( (error = OSS_SemCreate( llHdl-&gt;osHdl, OSS_SEM_BIN,
00171                                 0, &amp;llHdl-&gt;exeSem )))
00172         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl,error) );
00173     DBGWRT_2((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"  INIT:  exeSem created whith 0\n"</span> ));
00174 
00175     <span class="comment">/*------------------------------+</span>
00176 <span class="comment">    |  scan descriptor              |</span>
00177 <span class="comment">    +------------------------------*/</span>
00178     <span class="comment">/* prepare access */</span>
00179     <span class="keywordflow">if</span> ((error = DESC_Init(descP, osHdl, &amp;llHdl-&gt;descHdl)))
00180         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl,error) );
00181 
00182     <span class="comment">/* DEBUG_LEVEL_DESC */</span>
00183     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00184                                 &amp;value, <span class="stringliteral">"DEBUG_LEVEL_DESC"</span>)) &amp;&amp;
00185         error != ERR_DESC_KEY_NOTFOUND)
00186         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl,error) );
00187 
00188     DESC_DbgLevelSet(llHdl-&gt;descHdl, value);    <span class="comment">/* set level */</span>
00189 
00190     <span class="comment">/* DEBUG_LEVEL */</span>
00191     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00192                                 &amp;llHdl-&gt;dbgLevel, <span class="stringliteral">"DEBUG_LEVEL"</span>)) &amp;&amp;
00193         error != ERR_DESC_KEY_NOTFOUND)
00194         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl, error) );
00195 
00196     llHdl-&gt;dbgLevel = DBG_ALL;
00197 
00198     <span class="comment">/* IRQ_ENABLE */</span>
00199     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 0,
00200                                 &amp;value, <span class="stringliteral">"IRQ_ENABLE"</span>)) &amp;&amp;
00201         error != ERR_DESC_KEY_NOTFOUND)
00202         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl, error) );
00203 
00204     <span class="keywordflow">if</span>( value == 0 )
00205         llHdl-&gt;mode |= <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>;
00206 
00207     <span class="comment">/* AUTO_SKIPROM */</span>
00208     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 1,
00209                                 &amp;value, <span class="stringliteral">"AUTO_SKIPROM"</span>)) &amp;&amp;
00210         error != ERR_DESC_KEY_NOTFOUND)
00211         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl, error) );
00212 
00213     <span class="keywordflow">if</span>( value == 1 )
00214         llHdl-&gt;mode |= <a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>;
00215 
00216     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Init (ma=0x%08p) in %s mode\n"</span>,
00217                     llHdl-&gt;ma,
00218                     (llHdl-&gt;mode &amp; <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>) ? <span class="stringliteral">"polled"</span> : <span class="stringliteral">"irq"</span>));
00219 
00220     <span class="comment">/*------------------------------+</span>
00221 <span class="comment">    |  init hardware                |</span>
00222 <span class="comment">    +------------------------------*/</span>
00223     <span class="comment">/* do accesses here in polled mode */</span>
00224     <a class="code" href="z72__drv_8c.html#a4">Z72_SetStat</a>(llHdl, M_MK_IRQ_ENABLE, 0, 0);
00225 
00226     <span class="keywordflow">if</span>( (error = <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( llHdl )) != ERR_SUCCESS ) {
00227         DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Init: No OWB devices present\n"</span>));
00228         <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl, error) );
00229     }
00230 
00231     <span class="comment">/* enable interrupts? */</span>
00232     <span class="keywordflow">if</span>( !(llHdl-&gt;mode &amp; <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>) ) {
00233         <a class="code" href="z72__drv_8c.html#a4">Z72_SetStat</a>(llHdl, M_MK_IRQ_ENABLE, 0, 1);
00234     }
00235 
00236     *llHdlP = llHdl;    <span class="comment">/* set low-level driver handle */</span>
00237 
00238     <span class="keywordflow">return</span>(ERR_SUCCESS);
00239 }
00240 
00241 <span class="comment">/****************************** Z72_Exit ************************************/</span>
<a name="l00251"></a><a class="code" href="z72__drv_8c.html#a1">00251</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a1">Z72_Exit</a>(
00252    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>    **llHdlP
00253 )
00254 {
00255     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = *llHdlP;
00256     int32 error = 0;
00257 
00258     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Exit\n"</span>));
00259 
00260     <span class="comment">/*------------------------------+</span>
00261 <span class="comment">    |  de-init hardware             |</span>
00262 <span class="comment">    +------------------------------*/</span>
00263     <span class="comment">/* disable interrupts */</span>
00264     <a class="code" href="z72__drv_8c.html#a4">Z72_SetStat</a>(llHdl, M_MK_IRQ_ENABLE, 0, 0);
00265 
00266     <span class="comment">/*------------------------------+</span>
00267 <span class="comment">    |  clean up memory               |</span>
00268 <span class="comment">    +------------------------------*/</span>
00269     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00270     error = <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(llHdl,error);
00271 
00272     <span class="keywordflow">return</span>(error);
00273 }
00274 
00275 <span class="comment">/****************************** Z72_Read ************************************/</span>
<a name="l00284"></a><a class="code" href="z72__drv_8c.html#a2">00284</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a2">Z72_Read</a>(
00285     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00286     int32 ch,
00287     int32 *valueP
00288 )
00289 {
00290     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Read: not supported\n"</span>));
00291 
00292     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00293 }
00294 
00295 <span class="comment">/****************************** Z72_Write ***********************************/</span>
<a name="l00304"></a><a class="code" href="z72__drv_8c.html#a3">00304</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a3">Z72_Write</a>(
00305     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00306     int32 ch,
00307     int32 value
00308 )
00309 {
00310     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_Write: not supported\n"</span>));
00311 
00312     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00313 }
00314 
00315 <span class="comment">/****************************** Z72_SetStat *********************************/</span>
<a name="l00329"></a><a class="code" href="z72__drv_8c.html#a4">00329</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a4">Z72_SetStat</a>(
00330     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00331     int32  code,
00332     int32  ch,
00333     INT32_OR_64 value32_or_64
00334 )
00335 {
00336     int32 value = (int32)value32_or_64;     <span class="comment">/* 32bit value */</span>
00337     <span class="comment">/* INT32_OR_64 valueP = value32_or_64;     stores 32/64bit pointer */</span>
00338     int32 error = ERR_SUCCESS;
00339     u_int8 retVal;
00340 
00341     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_SetStat: ch=%d code=0x%04x value=0x%x\n"</span>,
00342               ch,code,value));
00343 
00344     <span class="keywordflow">switch</span>(code) {
00345         <span class="comment">/*--------------------------+</span>
00346 <span class="comment">        |  debug level              |</span>
00347 <span class="comment">        +--------------------------*/</span>
00348         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00349             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a> = value;
00350             <span class="keywordflow">break</span>;
00351         <span class="comment">/*--------------------------+</span>
00352 <span class="comment">        |  enable interrupts        |</span>
00353 <span class="comment">        +--------------------------*/</span>
00354         <span class="keywordflow">case</span> M_MK_IRQ_ENABLE:
00355             retVal = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> );
00356             <span class="keywordflow">if</span>( value ) {
00357                 <span class="comment">/* reset status bits */</span>
00358                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a>,
00359                             (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) );
00360                 <span class="comment">/* enable interrupts */</span>
00361                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a>,
00362                             retVal | <a class="code" href="z72__drv__int_8h.html#a25">Z72_CTL_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a26">Z72_CTL_EIRQ</a> );
00363 
00364                 <span class="comment">/* use interrupts/semaphores to wait for ready */</span>
00365                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp;= ~<a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>;
00366             } <span class="keywordflow">else</span> {
00367                 <span class="comment">/* use polling mode to wait for ready */</span>
00368                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> |= <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>;
00369 
00370                 <span class="comment">/* disable interrupts */</span>
00371                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a>,
00372                             retVal &amp; ~(<a class="code" href="z72__drv__int_8h.html#a25">Z72_CTL_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a26">Z72_CTL_EIRQ</a>) );
00373             }
00374             <span class="keywordflow">break</span>;
00375         <span class="comment">/*--------------------------+</span>
00376 <span class="comment">        |  set irq counter          |</span>
00377 <span class="comment">        +--------------------------*/</span>
00378         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00379             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a> = value;
00380             <span class="keywordflow">break</span>;
00381 
00382         <span class="comment">/*-----------------------------+</span>
00383 <span class="comment">        |  set automatic skip ROM mode |</span>
00384 <span class="comment">        +-----------------------------*/</span>
00385         <span class="keywordflow">case</span> Z72_ROM_SKIP_AUTOEN:
00386             <span class="keywordflow">if</span>( value )
00387                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> |= <a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>;
00388             <span class="keywordflow">else</span>
00389                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp;= ~<a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>;
00390             <span class="keywordflow">break</span>;
00391 
00392         <span class="comment">/*--------------------------+</span>
00393 <span class="comment">        |  (unknown)                |</span>
00394 <span class="comment">        +--------------------------*/</span>
00395         <span class="keywordflow">default</span>:
00396             error = ERR_LL_UNK_CODE;
00397     }
00398 
00399     <span class="keywordflow">return</span>(error);
00400 }
00401 
00402 <span class="comment">/****************************** Z72_GetStat *********************************/</span>
<a name="l00418"></a><a class="code" href="z72__drv_8c.html#a5">00418</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a5">Z72_GetStat</a>(
00419     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00420     int32  code,
00421     int32  ch,
00422     INT32_OR_64 *value32_or_64P
00423 )
00424 {
00425     int32 *valueP = (int32*)value32_or_64P;             <span class="comment">/* pointer to 32bit value  */</span>
00426     INT32_OR_64 *value64P = value32_or_64P;             <span class="comment">/* stores 32/64bit pointer  */</span>
00427     <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a> *blk = (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a>*)value32_or_64P;      <span class="comment">/* stores block struct pointer */</span>
00428 
00429     int32 error = ERR_SUCCESS;
00430 
00431     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_GetStat: ch=%d code=0x%04x\n"</span>,
00432               ch,code));
00433 
00434     <span class="keywordflow">switch</span>(code)
00435     {
00436         <span class="comment">/*--------------------------+</span>
00437 <span class="comment">        |  debug level              |</span>
00438 <span class="comment">        +--------------------------*/</span>
00439         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00440             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a>;
00441             <span class="keywordflow">break</span>;
00442         <span class="comment">/*--------------------------+</span>
00443 <span class="comment">        |  number of channels       |</span>
00444 <span class="comment">        +--------------------------*/</span>
00445         <span class="keywordflow">case</span> M_LL_CH_NUMBER:
00446             *valueP = <a class="code" href="z72__drv__int_8h.html#a1">CH_NUMBER</a>;
00447             <span class="keywordflow">break</span>;
00448         <span class="comment">/*--------------------------+</span>
00449 <span class="comment">        |  channel direction        |</span>
00450 <span class="comment">        +--------------------------*/</span>
00451         <span class="keywordflow">case</span> M_LL_CH_DIR:
00452             *valueP = M_CH_INOUT;
00453             <span class="keywordflow">break</span>;
00454         <span class="comment">/*--------------------------+</span>
00455 <span class="comment">        |  channel length [bits]    |</span>
00456 <span class="comment">        +--------------------------*/</span>
00457         <span class="keywordflow">case</span> M_LL_CH_LEN:
00458             *valueP = 32;
00459             <span class="keywordflow">break</span>;
00460         <span class="comment">/*--------------------------+</span>
00461 <span class="comment">        |  channel type info        |</span>
00462 <span class="comment">        +--------------------------*/</span>
00463         <span class="keywordflow">case</span> M_LL_CH_TYP:
00464             *valueP = M_CH_BINARY;
00465             <span class="keywordflow">break</span>;
00466         <span class="comment">/*--------------------------+</span>
00467 <span class="comment">        |  irq counter              |</span>
00468 <span class="comment">        +--------------------------*/</span>
00469         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00470             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>;
00471             <span class="keywordflow">break</span>;
00472         <span class="comment">/*--------------------------+</span>
00473 <span class="comment">        |  ID PROM check enabled    |</span>
00474 <span class="comment">        +--------------------------*/</span>
00475         <span class="keywordflow">case</span> M_LL_ID_CHECK:
00476             *valueP = 0;
00477             <span class="keywordflow">break</span>;
00478         <span class="comment">/*--------------------------+</span>
00479 <span class="comment">        |   ident table pointer     |</span>
00480 <span class="comment">        |   (treat as non-block!)   |</span>
00481 <span class="comment">        +--------------------------*/</span>
00482         <span class="keywordflow">case</span> M_MK_BLK_REV_ID:
00483            *value64P = (INT32_OR_64)&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o5">idFuncTbl</a>;
00484            <span class="keywordflow">break</span>;
00485         <span class="comment">/*--------------------------+</span>
00486 <span class="comment">        |  get ROM content          |</span>
00487 <span class="comment">        +--------------------------*/</span>
00488         <span class="keywordflow">case</span> Z72_BLK_ROM_READ:
00489             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL ||
00490                 blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a> &lt; Z72_OWB_ROM_LEN )
00491             {
00492                 error = ERR_LL_ILL_PARAM;
00493                 <span class="keywordflow">break</span>;
00494             }
00495             error = <a class="code" href="z72__drv_8c.html#a12">readRom</a>( llHdl, (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a> );
00496             <span class="keywordflow">break</span>;
00497         <span class="comment">/*--------------------------+</span>
00498 <span class="comment">        |  get memory content       |</span>
00499 <span class="comment">        +--------------------------*/</span>
00500         <span class="keywordflow">case</span> Z72_BLK_MEM:
00501             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL )
00502             {
00503                 error = ERR_LL_ILL_PARAM;
00504                 <span class="keywordflow">break</span>;
00505             }
00506             error = <a class="code" href="z72__drv_8c.html#a14">readMemory</a>( llHdl, <a class="code" href="z72__drv__int_8h.html#a76a57">Z72_ST_MAJ_MEM_READ</a>,
00507                                 (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, (u_int16)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a>,
00508                                 *(u_int16*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> );
00509             <span class="keywordflow">break</span>;
00510         <span class="comment">/*------------------------------------------------+</span>
00511 <span class="comment">        |  get memory content &amp; generate CRC on each page |</span>
00512 <span class="comment">        +------------------------------------------------*/</span>
00513         <span class="keywordflow">case</span> Z72_BLK_MEM_CRC:
00514             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL )
00515             {
00516                 error = ERR_LL_ILL_PARAM;
00517                 <span class="keywordflow">break</span>;
00518             }
00519             error = <a class="code" href="z72__drv_8c.html#a14">readMemory</a>( llHdl, <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a>,
00520                                 (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, (u_int16)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a>,
00521                                 *(u_int16*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> );
00522             <span class="keywordflow">break</span>;
00523         <span class="comment">/*--------------------------+</span>
00524 <span class="comment">        |  get memory content       |</span>
00525 <span class="comment">        +--------------------------*/</span>
00526         <span class="keywordflow">case</span> Z72_BLK_STATUS:
00527             <span class="keywordflow">if</span>( blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> == NULL )
00528             {
00529                 error = ERR_LL_ILL_PARAM;
00530                 <span class="keywordflow">break</span>;
00531             }
00532             error = <a class="code" href="z72__drv_8c.html#a14">readMemory</a>( llHdl, <a class="code" href="z72__drv__int_8h.html#a76a60">Z72_ST_MAJ_STATUS_READ</a>,
00533                                 (u_int8*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>, (u_int16)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a>,
00534                                 *(u_int16*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a> );
00535             <span class="keywordflow">break</span>;
00536         <span class="comment">/*--------------------------+</span>
00537 <span class="comment">        |  unknown                  |</span>
00538 <span class="comment">        +--------------------------*/</span>
00539         <span class="keywordflow">default</span>:
00540             error = ERR_LL_UNK_CODE;
00541     }
00542 
00543     <span class="keywordflow">return</span>(error);
00544 }
00545 
00546 <span class="comment">/******************************* Z72_BlockRead ******************************/</span>
<a name="l00557"></a><a class="code" href="z72__drv_8c.html#a6">00557</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a6">Z72_BlockRead</a>(
00558      <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00559      int32     ch,
00560      <span class="keywordtype">void</span>      *buf,
00561      int32     size,
00562      int32     *nbrRdBytesP
00563 )
00564 {
00565     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_BlockRead: not supported\n"</span>));
00566 
00567     <span class="comment">/* return number of read bytes */</span>
00568     *nbrRdBytesP = 0;
00569 
00570     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00571 }
00572 
00573 <span class="comment">/****************************** Z72_BlockWrite ******************************/</span>
<a name="l00584"></a><a class="code" href="z72__drv_8c.html#a7">00584</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a7">Z72_BlockWrite</a>(
00585      <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00586      int32     ch,
00587      <span class="keywordtype">void</span>      *buf,
00588      int32     size,
00589      int32     *nbrWrBytesP
00590 )
00591 {
00592     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_BlockWrite: not supported \n"</span>));
00593 
00594     <span class="comment">/* return number of written bytes */</span>
00595     *nbrWrBytesP = 0;
00596 
00597     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00598 }
00599 
00600 
00601 <span class="comment">/****************************** Z72_Irq ************************************/</span>
<a name="l00614"></a><a class="code" href="z72__drv_8c.html#a8">00614</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a8">Z72_Irq</a>(
00615    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
00616 )
00617 {
00618     u_int8 irqReq;
00619     IDBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z72_Irq:\n"</span>));
00620 
00621     <span class="comment">/* interrupt caused by Z72_OWB ? */</span>
00622     irqReq = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
00623 
00624     <span class="keywordflow">if</span>( irqReq &amp; (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) ) {
00625 
00626         <span class="comment">/* release interrupt */</span>
00627         MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a>,
00628                     irqReq &amp; (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) );
00629 
00630         <span class="comment">/* save status */</span>
00631         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> = irqReq;
00632 
00633         <span class="comment">/* inform waiting task */</span>
00634         OSS_SemSignal( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> );
00635 
00636         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>++;
00637         <span class="keywordflow">return</span>( LL_IRQ_DEVICE );
00638     }
00639 
00640     <span class="keywordflow">return</span>(LL_IRQ_DEV_NOT);     <span class="comment">/* say: not me */</span>
00641 }
00642 
00643 <span class="comment">/****************************** Z72_Info ***********************************/</span>
<a name="l00681"></a><a class="code" href="z72__drv_8c.html#a9">00681</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a9">Z72_Info</a>(
00682    int32  infoType,
00683    ...
00684 )
00685 {
00686     int32   error = ERR_SUCCESS;
00687     va_list argptr;
00688 
00689     va_start(argptr, infoType );
00690 
00691     <span class="keywordflow">switch</span>(infoType) {
00692         <span class="comment">/*-------------------------------+</span>
00693 <span class="comment">        |  hardware characteristics      |</span>
00694 <span class="comment">        |  (all addr/data modes ORed)   |</span>
00695 <span class="comment">        +-------------------------------*/</span>
00696         <span class="keywordflow">case</span> LL_INFO_HW_CHARACTER:
00697         {
00698             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00699             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00700 
00701             *addrModeP = MDIS_MA08;
00702             *dataModeP = MDIS_MD08 | MDIS_MD16;
00703             <span class="keywordflow">break</span>;
00704         }
00705         <span class="comment">/*-------------------------------+</span>
00706 <span class="comment">        |  nr of required address spaces |</span>
00707 <span class="comment">        |  (total spaces used)           |</span>
00708 <span class="comment">        +-------------------------------*/</span>
00709         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE_COUNT:
00710         {
00711             u_int32 *nbrOfAddrSpaceP = va_arg(argptr, u_int32*);
00712 
00713             *nbrOfAddrSpaceP = <a class="code" href="z72__drv__int_8h.html#a3">ADDRSPACE_COUNT</a>;
00714             <span class="keywordflow">break</span>;
00715         }
00716         <span class="comment">/*-------------------------------+</span>
00717 <span class="comment">        |  address space type            |</span>
00718 <span class="comment">        |  (widest used data mode)       |</span>
00719 <span class="comment">        +-------------------------------*/</span>
00720         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE:
00721         {
00722             u_int32 addrSpaceIndex = va_arg(argptr, u_int32);
00723             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00724             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00725             u_int32 *addrSizeP = va_arg(argptr, u_int32*);
00726 
00727             <span class="keywordflow">if</span> (addrSpaceIndex &gt;= <a class="code" href="z72__drv__int_8h.html#a3">ADDRSPACE_COUNT</a>)
00728                 error = ERR_LL_ILL_PARAM;
00729             <span class="keywordflow">else</span> {
00730                 *addrModeP = MDIS_MA08;
00731                 *dataModeP = MDIS_MD16;
00732                 *addrSizeP = <a class="code" href="z72__drv__int_8h.html#a4">ADDRSPACE_SIZE</a>;
00733             }
00734 
00735             <span class="keywordflow">break</span>;
00736         }
00737         <span class="comment">/*-------------------------------+</span>
00738 <span class="comment">        |   interrupt required           |</span>
00739 <span class="comment">        +-------------------------------*/</span>
00740         <span class="keywordflow">case</span> LL_INFO_IRQ:
00741         {
00742             u_int32 *useIrqP = va_arg(argptr, u_int32*);
00743 
00744             *useIrqP = <a class="code" href="z72__drv__int_8h.html#a2">USE_IRQ</a>;
00745             <span class="keywordflow">break</span>;
00746         }
00747         <span class="comment">/*-------------------------------+</span>
00748 <span class="comment">        |   process lock mode            |</span>
00749 <span class="comment">        +-------------------------------*/</span>
00750         <span class="keywordflow">case</span> LL_INFO_LOCKMODE:
00751         {
00752             u_int32 *lockModeP = va_arg(argptr, u_int32*);
00753 
00754             *lockModeP = LL_LOCK_CALL;
00755             <span class="keywordflow">break</span>;
00756         }
00757         <span class="comment">/*-------------------------------+</span>
00758 <span class="comment">        |   (unknown)                    |</span>
00759 <span class="comment">        +-------------------------------*/</span>
00760         <span class="keywordflow">default</span>:
00761           error = ERR_LL_ILL_PARAM;
00762     }
00763 
00764     va_end(argptr);
00765     <span class="keywordflow">return</span>(error);
00766 }
00767 
00768 <span class="comment">/*******************************  Ident  ***********************************/</span>
<a name="l00773"></a><a class="code" href="z72__drv_8c.html#a10">00773</a> <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z72__drv_8c.html#a10">Ident</a>( <span class="keywordtype">void</span> )
00774 {
00775     <span class="keywordflow">return</span>( <span class="stringliteral">"Z72 - Z72 low-level driver: $Id: z72_drv.c,v 1.3 2010/03/12 14:20:32 amorbach Exp $"</span> );
00776 }
00777 
00778 <span class="comment">/********************************* Cleanup *********************************/</span>
<a name="l00788"></a><a class="code" href="z72__drv_8c.html#a11">00788</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a11">Cleanup</a>(
00789    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>    *llHdl,
00790    int32        retCode
00791 )
00792 {
00793     <span class="comment">/*------------------------------+</span>
00794 <span class="comment">    |  close handles                |</span>
00795 <span class="comment">    +------------------------------*/</span>
00796     <span class="comment">/* clean up desc */</span>
00797     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>)
00798         DESC_Exit(&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>);
00799 
00800     <span class="comment">/* clean up semaphores */</span>
00801     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> != NULL)
00802         OSS_SemRemove( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> );
00803 
00804     <span class="comment">/* clean up debug */</span>
00805     DBGEXIT((&amp;<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>));
00806 
00807     <span class="comment">/*------------------------------+</span>
00808 <span class="comment">    |  free memory                  |</span>
00809 <span class="comment">    +------------------------------*/</span>
00810     <span class="comment">/* free my handle */</span>
00811     OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, (int8*)llHdl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o0">memAlloc</a>);
00812 
00813     <span class="comment">/*------------------------------+</span>
00814 <span class="comment">    |  return error code            |</span>
00815 <span class="comment">    +------------------------------*/</span>
00816     <span class="keywordflow">return</span>(retCode);
00817 }
00818 
00819 <span class="comment">/********************************* readRom *********************************/</span>
<a name="l00831"></a><a class="code" href="z72__drv_8c.html#a12">00831</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a12">readRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *buf, u_int32 numBytes )
00832 {
00833     int32 error = ERR_SUCCESS;
00834     u_int32 i;
00835     u_int8 owbCmd;
00836     <span class="comment">/* initialize crc */</span>
00837     u_int8 crc;
00838 
00839     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readRom\n"</span>));
00840 
00841     <span class="keywordflow">if</span>( numBytes &lt; Z72_OWB_ROM_LEN ) {
00842         error = ERR_LL_ILL_PARAM;
00843         <span class="keywordflow">goto</span> CLEANUP;
00844     }
00845 
00846     <span class="comment">/* do Reset/Presence Pulse Cycle */</span>
00847     <span class="keywordflow">if</span>( (error = <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( llHdl )) != ERR_SUCCESS )
00848         <span class="keywordflow">goto</span> CLEANUP;
00849 
00850     <span class="comment">/* send command */</span>
00851     owbCmd = <a class="code" href="group____Z72__DS2502.html#a4">Z72_OWB_ROM_READ</a>;
00852     <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
00853 
00854     <span class="keywordflow">for</span>( i = 0; error == ERR_SUCCESS &amp;&amp; i &lt; Z72_OWB_ROM_LEN; i++) {
00855         error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;buf[i], <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
00856     }
00857 
00858     DBGWRT_4(( <a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"\nZ72_ROM: Family: 0x%02x\n"</span>
00859                     <span class="stringliteral">"         Serial: 0x%02x     0x%02x\n"</span>,
00860                     buf[0], buf[1], buf[2] ));
00861     <span class="keywordflow">for</span>( i = 3; i &lt; Z72_OWB_ROM_LEN - 1; i+=2) {
00862         DBGWRT_4(( <a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"                 0x%02x     0x%02x\n"</span>,
00863                         buf[i], buf[i+1] ));
00864     }
00865     DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"            CRC: 0x%02x\n"</span>, buf[Z72_OWB_ROM_LEN - 1] ));
00866 
00867     crc = <a class="code" href="z72__drv_8c.html#a21">bufCrc8</a>( <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>, buf, 7 );
00868     <span class="keywordflow">if</span>( crc != buf[Z72_OWB_ROM_LEN - 1] ) {
00869         DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"LL - Z72_OWB readRom: CRC is 0x%02x; sb 0x%02x\n"</span>,
00870                         crc, buf[Z72_OWB_ROM_LEN - 1] ));
00871         error = Z72_ERR_CRC;
00872         <span class="keywordflow">goto</span> CLEANUP;
00873     }
00874 
00875     <span class="keywordflow">if</span>( error ) {
00876         <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( llHdl );
00877     } <span class="keywordflow">else</span> {
00878         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = <a class="code" href="z72__drv__int_8h.html#a76a56">Z72_ST_MAJ_IDLE_MEM</a>;
00879     }
00880 
00881 CLEANUP:
00882     <span class="keywordflow">return</span> error;
00883 }
00884 
00885 <span class="comment">/********************************* readRom ***********************************/</span>
<a name="l00892"></a><a class="code" href="z72__drv_8c.html#a13">00892</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a13">skipRom</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
00893 {
00894     int32 error   = ERR_LL_ILL_FUNC;
00895     u_int8 owbCmd;
00896     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB skipRom\n"</span>));
00897 
00898     <span class="comment">/* do Reset/Presence Pulse Cycle */</span>
00899     <span class="keywordflow">if</span>( (error = <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( llHdl )) != ERR_SUCCESS )
00900         <span class="keywordflow">goto</span> CLEANUP;
00901 
00902     owbCmd = <a class="code" href="group____Z72__DS2502.html#a7">Z72_OWB_ROM_SKIP</a>;
00903     error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
00904 
00905     <span class="keywordflow">if</span>( error ) {
00906         <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( llHdl );
00907     } <span class="keywordflow">else</span> {
00908         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = <a class="code" href="z72__drv__int_8h.html#a76a56">Z72_ST_MAJ_IDLE_MEM</a>;
00909     }
00910 
00911 CLEANUP:
00912     <span class="keywordflow">return</span>( error );
00913 }
00914 
00915 <span class="comment">/********************************* readMemory ********************************/</span>
<a name="l00929"></a><a class="code" href="z72__drv_8c.html#a14">00929</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a14">readMemory</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00930                          u_int32 majState,
00931                          u_int8 *buf,
00932                          u_int16 size,
00933                          u_int16 offs )
00934 {
00935     int32 error = ERR_SUCCESS;
00936     u_int32 rdIdx = 0;
00937     u_int8 owbCmd, rdVal = 0, crc;
00938 
00939     DBGWRT_1((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory start=0x%04x len=0x%04x\n"</span>,
00940                     offs, size));
00941 
00942     <span class="keywordflow">if</span>( size &lt;= 0 )
00943         <span class="keywordflow">goto</span> CLEANUP;
00944 
00945     <span class="keywordflow">if</span>( offs &gt;= Z72_OWB_DS2502_MEM_SIZE ){
00946         error = Z72_ERR_BEYOND_MEM;
00947         <span class="keywordflow">goto</span> CLEANUP;
00948     }
00949 
00950     <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> != <a class="code" href="z72__drv__int_8h.html#a76a56">Z72_ST_MAJ_IDLE_MEM</a> &amp;&amp;
00951         ( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> != <a class="code" href="z72__drv__int_8h.html#a76a50">Z72_ST_MAJ_IDLE</a> ||
00952           !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp; <a class="code" href="z72__drv__int_8h.html#a36">Z72_MODE_AUTO_SKIPROM</a>) ||
00953           (error = <a class="code" href="z72__drv_8c.html#a13">skipRom</a>( llHdl )) != ERR_SUCCESS) )
00954     {
00955         <span class="comment">/* !IDLE_MEM &amp; (!IDLE | !AUTO_SKIPROM | skipRom() != SUCC ) */</span>
00956         <span class="keywordflow">if</span>( error == ERR_SUCCESS )
00957             error = Z72_ERR_NO_ROMFKT;
00958         <span class="keywordflow">goto</span> CLEANUP;
00959     }
00960 
00961     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = majState;
00962     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a63">Z72_ST_RX_CMD</a>;
00963 
00964     <span class="keywordflow">do</span>{
00965         DBGWRT_3((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory state %d\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> ));
00966         <span class="keywordflow">switch</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> )
00967         {
00968             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a63">Z72_ST_RX_CMD</a> ):
00969             {
00970                 <span class="keywordflow">switch</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> )
00971                 {
00972                     <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a76a57">Z72_ST_MAJ_MEM_READ</a> ):
00973                         owbCmd = <a class="code" href="group____Z72__DS2502.html#a8">Z72_OWB_DS2502_MEM_READ</a>;
00974                         <span class="keywordflow">break</span>;
00975                     <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a> ):
00976                         owbCmd = <a class="code" href="group____Z72__DS2502.html#a9">Z72_OWB_DS2502_MEM_READ_CRC</a>;
00977                         <span class="keywordflow">break</span>;
00978                     <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a76a60">Z72_ST_MAJ_STATUS_READ</a> ):
00979                         owbCmd = <a class="code" href="group____Z72__DS2502.html#a11">Z72_OWB_DS2502_STATUS_READ</a>;
00980                         <span class="keywordflow">break</span>;
00981                     <span class="keywordflow">default</span>:
00982                         error = ERR_LL_ILL_PARAM;
00983                         <span class="keywordflow">goto</span> CLEANUP;
00984                 }
00985                 error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
00986                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
00987                     <span class="keywordflow">goto</span> CLEANUP;
00988 
00989                 crc = <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>;
00990                 <a class="code" href="z72__drv_8c.html#a19">byteCrc</a>( &amp;crc, owbCmd );
00991 
00992                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a64">Z72_ST_RX_TA</a>;
00993                 <span class="keywordflow">break</span>;
00994             }
00995             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a64">Z72_ST_RX_TA</a> ):
00996             {
00997                 owbCmd = (u_int8)(offs &amp; 0x00ff);
00998                 error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
00999                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01000                     <span class="keywordflow">goto</span> CLEANUP;
01001 
01002                 <a class="code" href="z72__drv_8c.html#a19">byteCrc</a>( &amp;crc, owbCmd );
01003 
01004                 owbCmd = (u_int8)((offs &amp; 0xff00) &gt;&gt; 8);
01005                 error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;owbCmd, <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> );
01006                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01007                     <span class="keywordflow">goto</span> CLEANUP;
01008 
01009                 <a class="code" href="z72__drv_8c.html#a19">byteCrc</a>( &amp;crc, owbCmd );
01010                 <a class="code" href="z72__drv_8c.html#a20">byteCrcFinish</a>( &amp;crc );
01011 
01012                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a65">Z72_ST_RX_CRC1</a>;
01013                 <span class="keywordflow">break</span>;
01014             }
01015             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a65">Z72_ST_RX_CRC1</a> ):
01016             {
01017                 <span class="comment">/* read CRC of command and address */</span>
01018                 error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;rdVal, <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
01019                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01020                     <span class="keywordflow">goto</span> CLEANUP;
01021 
01022                 <span class="keywordflow">if</span>( crc != rdVal ) {
01023                     error = Z72_ERR_CRC;
01024                     DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"LL - Z72_OWB readMemory: command/addr CRC "</span>
01025                                     <span class="stringliteral">"is 0x%02x; sb 0x%02x\n"</span>, crc, rdVal ));
01026                     <span class="keywordflow">goto</span> CLEANUP;
01027                 }
01028 
01029                 <span class="keywordflow">if</span>( error != ERR_SUCCESS ) <span class="comment">/* CRC error ? */</span>
01030                     <span class="keywordflow">goto</span> CLEANUP;
01031 
01032                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a>;
01033                 crc = <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>;
01034                 <span class="keywordflow">break</span>;
01035             }
01036             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a> ):
01037             {
01038                 error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;rdVal, <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
01039                 <span class="keywordflow">if</span>( error != ERR_SUCCESS )
01040                     <span class="keywordflow">goto</span> CLEANUP;
01041 
01042                 buf[rdIdx] = rdVal;
01043                 size -= 1;
01044 
01045                 <a class="code" href="z72__drv_8c.html#a19">byteCrc</a>( &amp;crc, rdVal );
01046 
01047                 DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory: "</span>
01048                                <span class="stringliteral">"rdIdx 0x%04x: rdVal=0x%02x    crc=0x%02x\n"</span>,
01049                                 rdIdx, rdVal, crc ));
01050 
01051                 <span class="comment">/* read memory and</span>
01052 <span class="comment">                 * reached end of data memory? */</span>
01053                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a57">Z72_ST_MAJ_MEM_READ</a> )
01054                 {
01055                     <span class="keywordflow">if</span>( (rdIdx + offs) == (Z72_OWB_DS2502_MEM_SIZE - 1)) {
01056                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a>;
01057                         <a class="code" href="z72__drv_8c.html#a20">byteCrcFinish</a>( &amp;crc );
01058                         <span class="keywordflow">break</span>;
01059                     }
01060                 }
01061 
01062                 <span class="comment">/* read memory &amp; generate CRC and</span>
01063 <span class="comment">                 * reached end of memory page?     */</span>
01064                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a> )
01065                 {
01066                     <span class="keywordflow">if</span>( !((rdIdx + offs + 1) % Z72_OWB_DS2502_MEM_PAGESIZE)) {
01067                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a>;
01068                         <a class="code" href="z72__drv_8c.html#a20">byteCrcFinish</a>( &amp;crc );
01069                         rdIdx++;
01070                         <span class="keywordflow">break</span>;
01071                     }
01072                 }
01073 
01074                 <span class="comment">/* read status and</span>
01075 <span class="comment">                 * reached end of status page? */</span>
01076                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a60">Z72_ST_MAJ_STATUS_READ</a> )
01077                 {
01078                     <span class="keywordflow">if</span>( (rdIdx + offs) == (Z72_OWB_DS2502_ST_SIZE - 1)) {
01079                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a>;
01080                         <a class="code" href="z72__drv_8c.html#a20">byteCrcFinish</a>( &amp;crc );
01081                         <span class="keywordflow">break</span>;
01082                     }
01083                 }
01084 
01085                 <span class="comment">/* reached desired size before end of memory/status */</span>
01086                 <span class="keywordflow">if</span>( !size )
01087                     <span class="keywordflow">goto</span> CLEANUP;
01088 
01089                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a>; <span class="comment">/* stay and read more */</span>
01090                 rdIdx++;
01091                 <span class="keywordflow">break</span>;
01092             }
01093             <span class="keywordflow">case</span>( <a class="code" href="z72__drv__int_8h.html#a77a67">Z72_ST_RX_CRC2</a> ):
01094             {
01095                 <span class="comment">/* read CRC of data */</span>
01096                 error = <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, &amp;rdVal, <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> );
01097 
01098                 <span class="keywordflow">if</span>( error == ERR_SUCCESS &amp;&amp; crc != rdVal ) {
01099                     error = Z72_ERR_CRC;
01100                     DBGWRT_ERR((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>,<span class="stringliteral">"LL - Z72_OWB readMemory: data CRC "</span>
01101                                     <span class="stringliteral">"is 0x%02x; sb 0x%02x\n"</span>, crc, rdVal ));
01102                 }
01103 
01104                 <span class="comment">/* computed crc of last page? If not, read next page     */</span>
01105                 <span class="keywordflow">if</span>( error == ERR_SUCCESS &amp;&amp;
01106                     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> == <a class="code" href="z72__drv__int_8h.html#a76a58">Z72_ST_MAJ_MEM_READ_CRC</a> &amp;&amp;
01107                     (rdIdx + offs) != Z72_OWB_DS2502_MEM_SIZE )
01108                 {
01109                     <span class="comment">/* start reading next page */</span>
01110                     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">fncState</a> = <a class="code" href="z72__drv__int_8h.html#a77a66">Z72_ST_RX_DATA</a>;
01111                     crc = <a class="code" href="group____Z72__DS2502.html#a3">Z72_OWB_ROMCRC_INIT</a>;
01112                     <span class="keywordflow">break</span>;
01113                 }
01114 
01115                 <span class="comment">/* finished */</span>
01116                 <span class="keywordflow">goto</span> CLEANUP;
01117             }
01118             <span class="keywordflow">default</span>:
01119                 error = Z72_ERR_UNDEF_STATE;
01120                 <span class="keywordflow">goto</span> CLEANUP;
01121         }
01122 
01123     } <span class="keywordflow">while</span> ( !error );
01124 
01125 
01126 CLEANUP:
01127     DBGWRT_2((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB readMemory finish (error = 0x%04x)\n"</span>,error));
01128     <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( llHdl );
01129     <span class="keywordflow">return</span> error;
01130 }
01131 
01132 <span class="comment">/********************************* masterTxReset *****************************/</span>
<a name="l01139"></a><a class="code" href="z72__drv_8c.html#a15">01139</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a15">masterTxReset</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
01140 {
01141     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">majState</a> = <a class="code" href="z72__drv__int_8h.html#a76a50">Z72_ST_MAJ_IDLE</a>;
01142     <span class="keywordflow">return</span>( <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( llHdl, NULL, <a class="code" href="z72__drv__int_8h.html#a20">Z72_CTL_CMD_RPP</a> ) );
01143 }
01144 
01145 <span class="comment">/********************************* waitOnReady *******************************/</span>
<a name="l01152"></a><a class="code" href="z72__drv_8c.html#a16">01152</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a16">waitOnReady</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
01153 {
01154     int32 error = ERR_SUCCESS;
01155 
01156     <span class="keywordflow">if</span>( !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">mode</a> &amp; <a class="code" href="z72__drv__int_8h.html#a35">Z72_MODE_POLL</a>) &amp;&amp;
01157         (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a> != NULL) )
01158     {
01159         <span class="comment">/* Note: signals are ignored here */</span>
01160         <span class="keywordflow">do</span> {
01161             DBGCMD( u_int8 ctl );
01162             DBGCMD( u_int8 sts );
01163 
01164             error = OSS_SemWait( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">exeSem</a>, <a class="code" href="z72__drv__int_8h.html#a7">Z72_SEM_TOUT</a> );
01165 
01166             DBGCMD( ctl = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> ) );
01167             DBGCMD( sts = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> ) );
01168             DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB waitOnReady(Sem) finish "</span>
01169                            <span class="stringliteral">"(error = 0x%04x) ctl=0x%02x sts=0x%02x\n"</span>,
01170                            error, ctl, sts));
01171         } <span class="keywordflow">while</span>( error==ERR_OSS_SIG_OCCURED );
01172     } <span class="keywordflow">else</span>
01173     {
01174         u_int8 sts;
01175         u_int32 retryCnt = <a class="code" href="z72__drv__int_8h.html#a6">Z72_POLL_RETRY_MAX</a>;
01176         DBGCMD( u_int8 ctl );
01177 
01178         <span class="keywordflow">do</span>{
01179             OSS_Delay( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, <a class="code" href="z72__drv__int_8h.html#a5">Z72_POLL_TOUT</a> );
01180             sts = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01181         } <span class="keywordflow">while</span>( (sts &amp; <a class="code" href="z72__drv__int_8h.html#a33">Z72_STS_BUSY</a>) &amp;&amp; retryCnt );
01182         <span class="comment">/* save status */</span>
01183         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01184 
01185         DBGCMD( ctl = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> ));
01186         DBGWRT_4((<a class="code" href="z72__drv__int_8h.html#a11">DBH</a>, <span class="stringliteral">"LL - Z72_OWB waitOnReady(Delay) finish "</span>
01187                        <span class="stringliteral">"(error = 0x%04x) ctl=0x%02x sts=0x%02x\n"</span>,
01188                        error, ctl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> ));
01189 
01190 
01191         <span class="comment">/* reset status bits */</span>
01192         MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a>,
01193                     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> &amp; (<a class="code" href="z72__drv__int_8h.html#a31">Z72_STS_MIRQ</a> | <a class="code" href="z72__drv__int_8h.html#a32">Z72_STS_EIRQ</a>) );
01194     }
01195     <span class="keywordflow">return</span> error;
01196 }
01197 
01198 <span class="comment">/********************************* getDevError *******************************/</span>
<a name="l01205"></a><a class="code" href="z72__drv_8c.html#a17">01205</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a17">getDevError</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl )
01206 {
01207     int32 error = ERR_SUCCESS;
01208 
01209     <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> &amp; ( <a class="code" href="z72__drv__int_8h.html#a27">Z72_STS_EEXE</a> | <a class="code" href="z72__drv__int_8h.html#a28">Z72_STS_ERPP</a> ) )
01210         error = Z72_ERR_NO_DEVICE;
01211     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> &amp; ( <a class="code" href="z72__drv__int_8h.html#a29">Z72_STS_EPP1</a> | <a class="code" href="z72__drv__int_8h.html#a30">Z72_STS_EPP2</a>) )
01212         error = Z72_ERR_PGM;
01213     <span class="keywordflow">return</span> error;
01214 }
01215 
01216 <span class="comment">/********************************* execCmd ***********************************/</span>
<a name="l01225"></a><a class="code" href="z72__drv_8c.html#a18">01225</a> <span class="keyword">static</span> int32 <a class="code" href="z72__drv_8c.html#a18">execCmd</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, u_int8 *data, u_int32 cmd )
01226 {
01227     int32 error = ERR_SUCCESS;
01228     u_int8 ctlReg, stsReg, tryCnt = 0;
01229 
01230     stsReg = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01231 
01232     <span class="keywordflow">while</span>( (stsReg &amp; <a class="code" href="z72__drv__int_8h.html#a33">Z72_STS_BUSY</a>) &amp;&amp;
01233            (tryCnt++ &lt; <a class="code" href="z72__drv__int_8h.html#a8">Z72_RETRY_MAX</a>) ){
01234         OSS_Delay( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, <a class="code" href="z72__drv__int_8h.html#a5">Z72_POLL_TOUT</a> );
01235         stsReg = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a16">Z72_REG_STS</a> );
01236     }
01237 
01238     <span class="keywordflow">if</span>( tryCnt &gt;= <a class="code" href="z72__drv__int_8h.html#a8">Z72_RETRY_MAX</a> ) {
01239         error = Z72_ERR_BUSY;
01240         <span class="keywordflow">goto</span> CLEANUP;
01241     }
01242 
01243     <span class="keywordflow">if</span>( cmd == <a class="code" href="z72__drv__int_8h.html#a18">Z72_CTL_CMD_WBIT</a> ||
01244         cmd == <a class="code" href="z72__drv__int_8h.html#a22">Z72_CTL_CMD_WBYT</a> )
01245     {
01246         MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a13">Z72_REG_WRT</a>, *data );
01247     }
01248 
01249     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">exeStatus</a> = 0;
01250 
01251     ctlReg = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a> ) &amp; ~<a class="code" href="z72__drv__int_8h.html#a17">Z72_CTL_CMD_MASK</a>;
01252     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a15">Z72_REG_CTL</a>, ctlReg | (u_int8)cmd | <a class="code" href="z72__drv__int_8h.html#a24">Z72_CTL_EXEC</a> );
01253 
01254     error = <a class="code" href="z72__drv_8c.html#a16">waitOnReady</a>( llHdl );
01255 
01256     <span class="keywordflow">if</span>( error ||
01257         (error = <a class="code" href="z72__drv_8c.html#a17">getDevError</a>( llHdl )) != ERR_SUCCESS )
01258     {
01259         <span class="keywordflow">goto</span> CLEANUP;
01260     }
01261 
01262     <span class="keywordflow">if</span>( cmd == <a class="code" href="z72__drv__int_8h.html#a19">Z72_CTL_CMD_RBIT</a> ||
01263         cmd == <a class="code" href="z72__drv__int_8h.html#a23">Z72_CTL_CMD_RBYT</a> )
01264     {
01265         *data = (u_int8)MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z72__drv__int_8h.html#a14">Z72_REG_RD</a> );
01266     }
01267 
01268 CLEANUP:
01269     <span class="keywordflow">return</span> error;
01270 }
01271 
01272 <span class="comment">/* CRC subroutines */</span>
01273 
01274 <span class="comment">/********************************* reflectByte *******************************/</span>
<a name="l01281"></a><a class="code" href="z72__drv_8c.html#a23">01281</a> <span class="keyword">static</span> u_int8 <a class="code" href="z72__drv_8c.html#a23">reflectByte</a> ( u_int8 c )
01282 {
01283     <span class="comment">/* reflects the Byte c */</span>
01284     u_int32 i, j = 1;
01285     u_int8 cout = 0;
01286 
01287     <span class="keywordflow">for</span>( i = 0x80; i; i &gt;&gt;= 1) {
01288         <span class="keywordflow">if</span>( c &amp; i )
01289             cout |= j;
01290         j &lt;&lt;= 1;
01291     }
01292     <span class="keywordflow">return</span>( cout );
01293 }
01294 
01295 <span class="comment">/********************************* byteCrc ***********************************/</span>
<a name="l01301"></a><a class="code" href="z72__drv_8c.html#a19">01301</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a19">byteCrc</a>( u_int8 *crc, u_int8 c )
01302 {
01303     u_int32 j;
01304     u_int8 bit;
01305 
01306     c = <a class="code" href="z72__drv_8c.html#a23">reflectByte</a>( c );
01307 
01308     <span class="keywordflow">for</span>( j = 0x80; j; j &gt;&gt;= 1)
01309     {
01310         bit = *crc &amp; <a class="code" href="group____Z72__DS2502.html#a1">Z72_OWB_ROMCRC_HIGHBIT</a>;
01311         *crc &lt;&lt;= 1;
01312         <span class="keywordflow">if</span>( c &amp; j )
01313             *crc |= 1;
01314         <span class="keywordflow">if</span>( bit )
01315             *crc ^= <a class="code" href="group____Z72__DS2502.html#a2">Z72_OWB_ROMCRC_POLY</a>;
01316     }
01317 }
01318 
01319 <span class="comment">/********************************* byteCrcFinish *****************************/</span>
<a name="l01324"></a><a class="code" href="z72__drv_8c.html#a20">01324</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z72__drv_8c.html#a20">byteCrcFinish</a>( u_int8 *crc )
01325 {
01326     u_int32 i;
01327     u_int8 bit;
01328 
01329     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="group____Z72__DS2502.html#a0">Z72_OWB_ROMCRC_ORDER</a>; i++)
01330     {
01331         bit = *crc &amp; <a class="code" href="group____Z72__DS2502.html#a1">Z72_OWB_ROMCRC_HIGHBIT</a>;
01332         *crc &lt;&lt;= 1;
01333         <span class="keywordflow">if</span>( bit )
01334             *crc ^= <a class="code" href="group____Z72__DS2502.html#a2">Z72_OWB_ROMCRC_POLY</a>;
01335     }
01336     *crc = <a class="code" href="z72__drv_8c.html#a23">reflectByte</a>( *crc );
01337 }
01338 
01339 <span class="comment">/********************************* bufCrc8 ***********************************/</span>
<a name="l01348"></a><a class="code" href="z72__drv_8c.html#a21">01348</a> <span class="keyword">static</span> u_int8 <a class="code" href="z72__drv_8c.html#a21">bufCrc8</a>( u_int8 crcStart, u_int8 *buf, u_int32 len)
01349 {
01350     u_int32 i;
01351     u_int8 crc = crcStart;
01352 
01353     <span class="keywordflow">for</span>( i = 0; i &lt; len; i++)
01354     {
01355         <a class="code" href="z72__drv_8c.html#a19">byteCrc</a>( &amp;crc, *buf++ );
01356     }
01357 
01358     <a class="code" href="z72__drv_8c.html#a20">byteCrcFinish</a>( &amp;crc );
01359     <span class="keywordflow">return</span>(crc);
01360 }
01361 
01362 
01363 
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Z72 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

